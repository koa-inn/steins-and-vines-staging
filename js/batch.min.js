!function(){"use strict";var t="",e="",n="";function a(){return(new Date).toLocaleDateString("en-CA",{timeZone:"America/Vancouver"})}function o(t){return t?String(t).substring(0,10):""}function r(t){if(!t)return"";var e=document.createElement("div");return e.textContent=String(t),e.innerHTML}function d(){if(n="undefined"!=typeof SHEETS_CONFIG&&SHEETS_CONFIG.ADMIN_API_URL||""){var a=new URLSearchParams(window.location.search);t=a.get("id")||"",e=a.get("token")||"",t&&e?(c(),setInterval(function(){if(!document.hidden){if(g>0){var a=Math.min(3e5,6e4*Math.pow(2,g-1));if(Date.now()-f<a)return}f=Date.now();var o=n+"?action=get_batch_public&batch_id="+encodeURIComponent(t)+"&token="+encodeURIComponent(e);fetch(o).then(function(t){return t.json()}).then(function(t){t.ok?(g=0,s(t.data)):g++}).catch(function(){g++})}},6e4)):b()}else b("Configuration error")}function c(){var a=n+"?action=get_batch_public&batch_id="+encodeURIComponent(t)+"&token="+encodeURIComponent(e);fetch(a).then(function(t){return t.json()}).then(function(t){t.ok?s(t.data):b(t.message)}).catch(function(t){b(t.message)})}function s(d){var s=d.batch,l=d.tasks||[],h=d.plato_readings||[],b=d.vessel_history||[];document.getElementById("batch-loading").style.display="none",document.getElementById("batch-content").style.display="";var g=String(s.status||"").toLowerCase(),f=document.getElementById("batch-status-badge");f.textContent={primary:"Primary Fermentation",secondary:"Secondary Fermentation",complete:"Complete",disabled:"Disabled"}[g]||g,f.className="batch-hero-status batch-hero-status--"+({primary:"primary",secondary:"secondary",complete:"complete",disabled:"disabled"}[g]||"gray"),document.getElementById("batch-title").textContent=s.batch_id,document.getElementById("batch-product").textContent=s.product_name||"",document.getElementById("batch-customer").textContent=s.customer_name||"",document.getElementById("batch-start-date").textContent=s.start_date?"Started: "+o(s.start_date):"",document.getElementById("batch-vessel").textContent=s.vessel_id||"—",document.getElementById("batch-shelf").textContent=s.shelf_id||"—",document.getElementById("batch-bin").textContent=s.bin_id||"—",function(d){var s=document.getElementById("batch-tasks-list");if(!d.length)return void(s.innerHTML='<p class="batch-empty">No tasks scheduled.</p>');var i=a(),l="";d.forEach(function(t){var e="TRUE"===String(t.completed).toUpperCase(),n="TRUE"===String(t.is_packaging).toUpperCase(),a="TRUE"===String(t.is_transfer).toUpperCase(),d=t.due_date?o(t.due_date):n?"TBD":"—",c="batch-task";e&&(c+=" batch-task--done"),!e&&t.due_date&&o(t.due_date)<i&&(c+=" batch-task--overdue"),l+='<div class="'+c+'">',l+='<label class="batch-task-label">',l+='<input type="checkbox" class="batch-task-checkbox" data-task-id="'+r(t.task_id)+'" '+(e?"checked":"")+(n?' disabled title="Staff only"':"")+">",l+='<span class="batch-task-title">'+r(t.title||"Step "+t.step_number)+"</span>",a&&(l+='<span class="batch-badge batch-badge--transfer">Transfer</span>'),n&&(l+='<span class="batch-badge batch-badge--pkg">Packaging</span>'),l+="</label>",l+='<span class="batch-task-due">'+d+"</span>",t.description&&(l+='<p class="batch-task-desc">'+r(t.description)+"</p>"),l+="</div>"}),s.innerHTML=l,s.querySelectorAll(".batch-task-checkbox").forEach(function(a){a.addEventListener("change",function(){var o,r,d;o=a.getAttribute("data-task-id"),r=a.checked,d={action:"update_batch_task",batch_token:e,batch_id:t,task_id:o,updates:{completed:r}},fetch(n,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(d)}).then(function(t){return t.json()}).then(function(t){t.ok?(p("Task "+(r?"completed":"unchecked"),"success"),c()):p("Failed: "+(t.message||t.error),"error")}).catch(function(t){p("Failed: "+t.message,"error")})})})}(l),u=h.slice(),m=s.start_date,i(u,m),s.notes&&(document.getElementById("batch-notes-card").style.display="",document.getElementById("batch-notes").textContent=s.notes),b.length>0&&(document.getElementById("batch-history-card").style.display="",function(t){var e=document.getElementById("batch-vessel-history"),n="";t.forEach(function(t){n+='<div class="batch-vh-entry">',n+="<strong>"+o(t.transferred_at)+"</strong> ",n+="S:"+r(t.shelf_id||"?")+" B:"+r(t.bin_id||"?")+" V:"+r(t.vessel_id||"?"),t.notes&&(n+=" — "+r(t.notes)),n+="</div>"}),e.innerHTML=n}(b))}function i(t,e){var n=document.getElementById("batch-plato-chart"),a=document.getElementById("batch-plato-list");if(!t||0===t.length)return n.innerHTML="",void(a.innerHTML='<p class="batch-empty">No readings yet.</p>');t.length>=2?n.innerHTML=function(t,e){var n=400,a=150,o=30,r=e?new Date(e):new Date(t[0].timestamp),d=t.map(function(t){var e=new Date(t.timestamp);return{day:Math.round((e-r)/864e5),plato:Number(t.degrees_plato)}}),c=Math.max.apply(null,d.map(function(t){return t.day}))||1,s=Math.max.apply(null,d.map(function(t){return t.plato})),i=Math.min.apply(null,d.map(function(t){return t.plato}));s===i&&(s+=1,i=Math.max(0,i-1));var l=s-i,u=d.map(function(t){return o+t.day/c*(n-2*o)+","+(a-o-(t.plato-i)/l*(a-2*o))}).join(" "),m=d.map(function(t){return'<circle cx="'+(o+t.day/c*(n-2*o))+'" cy="'+(a-o-(t.plato-i)/l*(a-2*o))+'" r="3" fill="#5b7f3b"/>'}).join(""),h='<svg viewBox="0 0 '+n+" "+a+'" class="batch-plato-svg">';return h+='<line x1="'+o+'" y1="'+(a-o)+'" x2="'+(n-o)+'" y2="'+(a-o)+'" stroke="#ccc"/>',h+='<line x1="'+o+'" y1="'+o+'" x2="'+o+'" y2="'+(a-o)+'" stroke="#ccc"/>',h+='<text x="'+o+'" y="'+(a-5)+'" font-size="10" fill="#999">Day 0</text>',h+='<text x="'+(n-o)+'" y="'+(a-5)+'" font-size="10" fill="#999" text-anchor="end">Day '+c+"</text>",h+='<text x="5" y="'+(o+4)+'" font-size="10" fill="#999">'+s.toFixed(1)+"</text>",h+='<text x="5" y="'+(a-o)+'" font-size="10" fill="#999">'+i.toFixed(1)+"</text>",h+='<polyline points="'+u+'" fill="none" stroke="#5b7f3b" stroke-width="2"/>',h+=m,h+="</svg>"}(t,e):n.innerHTML="";var d='<table class="batch-readings-table"><thead><tr><th>Date</th><th>&deg;P</th><th>Temp</th><th>pH</th><th>Notes</th></tr></thead><tbody>';t.slice().reverse().forEach(function(t){d+="<tr><td>"+o(t.timestamp)+"</td><td>"+r(t.degrees_plato)+"</td><td>"+r(null!=t.temperature&&""!==t.temperature?t.temperature:"")+"</td><td>"+r(null!=t.ph&&""!==t.ph?t.ph:"")+"</td><td>"+r(t.notes||"")+"</td></tr>"}),d+="</tbody></table>",a.innerHTML=d}var l=[],u=[],m=null;function h(){var a=document.getElementById("plato-staging-wrap");if(a)if(0!==l.length){var o='<table class="batch-readings-table" style="margin-top:0.5rem;"><thead><tr><th>Date</th><th>&deg;P</th><th>Temp</th><th>pH</th><th>Notes</th><th style="width:36px;"></th></tr></thead><tbody>';l.forEach(function(t,e){o+="<tr>",o+="<td>"+r(t.timestamp)+"</td>",o+="<td>"+r(t.degrees_plato)+"</td>",o+="<td>"+r(void 0!==t.temperature?t.temperature:"")+"</td>",o+="<td>"+r(void 0!==t.ph?t.ph:"")+"</td>",o+="<td>"+r(t.notes||"")+"</td>",o+='<td><button type="button" class="plato-staging-remove" data-idx="'+e+'" title="Remove" style="background:none;border:none;color:#c00;cursor:pointer;font-size:1.1rem;">&times;</button></td>',o+="</tr>"}),o+="</tbody></table>",o+='<button type="button" class="btn" id="plato-submit-all-btn">Submit All ('+l.length+")</button>",a.innerHTML=o,function(){document.querySelectorAll(".plato-staging-remove").forEach(function(t){t.addEventListener("click",function(){var e=parseInt(t.getAttribute("data-idx"),10);l.splice(e,1),h()})});var a=document.getElementById("plato-submit-all-btn");a&&a.addEventListener("click",function(){0!==l.length?(a.disabled=!0,a.textContent="Submitting...",fetch(n,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"bulk_add_plato_readings",batch_token:e,batch_id:t,readings:l})}).then(function(t){return t.json()}).then(function(t){if(!t.ok)return p("Failed: "+(t.message||t.error),"error"),a.disabled=!1,void(a.textContent="Submit All ("+l.length+")");p(l.length+" reading"+(1!==l.length?"s":"")+" recorded","success");var e=t&&t.results||[];l.forEach(function(t,n){u.push({reading_id:e[n]&&e[n].reading_id||"",degrees_plato:t.degrees_plato,timestamp:t.timestamp,temperature:t.temperature,ph:t.ph,notes:t.notes||""})}),l=[],h(),i(u,m)}).catch(function(t){p("Failed: "+t.message,"error"),a.disabled=!1,a.textContent="Submit All ("+l.length+")"})):p("No readings to submit","error")})}()}else a.innerHTML=""}function p(t,e){var n=document.getElementById("batch-toast-container");if(n){var a=document.createElement("div");a.className="batch-toast batch-toast--"+(e||"info"),a.textContent=t,n.appendChild(a),setTimeout(function(){a.classList.add("removing"),setTimeout(function(){a.parentNode&&a.parentNode.removeChild(a)},200)},3e3)}}function b(t){document.getElementById("batch-loading").style.display="none";var e=document.getElementById("batch-error");e.style.display="",t&&(e.querySelector("p").textContent=t)}var g=0;var f=0;document.addEventListener("DOMContentLoaded",function(){d(),function(){var t=document.getElementById("plato-date");t&&(t.value=a());var e=document.getElementById("plato-add-row-btn");e&&e.addEventListener("click",function(){var t=parseFloat(document.getElementById("plato-value").value);if(isNaN(t)||t<0||t>40)p("Enter a valid Plato value (0-40)","error");else{var e=document.getElementById("plato-date").value;if(e){var n=document.getElementById("plato-temp").value,a=document.getElementById("plato-ph").value;if(""!==a&&(isNaN(parseFloat(a))||parseFloat(a)<0||parseFloat(a)>14))p("pH must be between 0 and 14","error");else{var o={degrees_plato:t,timestamp:e,notes:document.getElementById("plato-notes").value};""!==n&&(o.temperature=parseFloat(n)),""!==a&&(o.ph=parseFloat(a)),l.push(o),h(),document.getElementById("plato-value").value="",document.getElementById("plato-temp").value="",document.getElementById("plato-ph").value="",document.getElementById("plato-notes").value=""}}else p("Enter a date","error")}})}()})}();