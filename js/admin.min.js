!function(){"use strict";console.log("[Admin] Build: 2026-02-11T23:43:23.474Z");var e=null,t=null,n=null,a=[],o=[],r=[],i=[],d=[],s=[],l=[],c=[],u=[],m=[],f=[],p=null,v=[],h={pending:{label:"Pending",description:"Awaiting confirmation",order:1},confirmed:{label:"Confirmed",description:"Appointment scheduled",order:2},brewing:{label:"Brewing",description:"Fermentation in progress",order:3},ready:{label:"Ready",description:"Ready for bottling pickup",order:4},completed:{label:"Completed",description:"Customer has bottled and picked up",order:5},cancelled:{label:"Cancelled",description:"Reservation was cancelled",order:6},archived:{label:"Archived",description:"Hidden from active view",order:7}},E={pending:["confirmed","cancelled"],confirmed:["brewing","cancelled"],brewing:["ready","cancelled"],ready:["completed","cancelled"],completed:["archived"],cancelled:["archived"],archived:["completed"]},g={offset:0,limit:50,total:0,filtered:0,currentFilter:"pending"};function y(e,t,n){t||(t="info"),n||(n={});var a=document.getElementById("admin-toast-container");if(a){var o=document.createElement("div");o.className="admin-toast admin-toast--"+t;var r=document.createElement("span");if(r.className="admin-toast-msg",r.textContent=e,o.appendChild(r),n.undo){var i=document.createElement("button");i.className="admin-toast-undo",i.textContent="Undo",i.addEventListener("click",function(){n.undo(),b(o)}),o.appendChild(i)}var d=document.createElement("button");d.className="admin-toast-close",d.innerHTML="&times;",d.addEventListener("click",function(){b(o)}),o.appendChild(d),a.appendChild(o);var s=n.duration||("error"===t?6e3:3500),l=setTimeout(function(){b(o)},s);o._timer=l}}function b(e){e._removed||(e._removed=!0,clearTimeout(e._timer),e.classList.add("removing"),setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e)},150))}function S(e){var t={pending:0,confirmed:0,brewing:0,ready:0,completed:0};(e||s).forEach(function(e){var n=(e.status||"").toLowerCase().trim()||"pending";t.hasOwnProperty(n)&&t[n]++});var n=document.getElementById("pipeline-stages");if(n){var a=t.pending+t.confirmed+t.brewing+t.ready+t.completed;if(0!==a){var o="",r={pending:"Pending",confirmed:"Confirmed",brewing:"Brewing",ready:"Ready",completed:"Done"};["pending","confirmed","brewing","ready","completed"].forEach(function(e){if(t[e]>0){Math.max(t[e]/a*100,12);o+='<div class="pipeline-stage pipeline-stage--'+e+'" style="flex:'+t[e]+';" data-filter="'+e+'">',o+='<span class="pipeline-stage-count">'+t[e]+"</span>",o+='<span class="pipeline-stage-name">'+r[e]+"</span>",o+="</div>"}}),n.innerHTML=o,n.querySelectorAll(".pipeline-stage").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-filter"),n=document.getElementById("res-status-filter");n&&(n.value=t,n.dispatchEvent(new Event("change"))),document.querySelector('[data-tab="reservations"]').click()})})}else n.innerHTML='<div class="pipeline-empty">No active batches</div>'}}function I(e){var t=document.getElementById("attention-list");if(t){var n=[],a=e&&e.pendingReservations||0;e||s.forEach(function(e){"pending"!==(e.status||"").toLowerCase().trim()&&e.status||a++}),a>0&&n.push({text:a+" reservation"+(1!==a?"s":"")+" to confirm",dot:"warning",tab:"reservations",filter:"pending"});var r=e&&e.readyReservations||0;e||s.forEach(function(e){"ready"===(e.status||"").toLowerCase().trim()&&r++}),r>0&&n.push({text:r+" ready for pickup",dot:"success",tab:"reservations",filter:"ready"});var i=e?(e.lowStockKits||[]).length:0;e||o.forEach(function(e){var t=parseInt(e.stock,10)||0,n=parseInt(e.on_hold,10)||0;"true"!==e.hide&&"TRUE"!==e.hide&&t-n<=3&&i++}),i>0&&n.push({text:i+" kit"+(1!==i?"s":"")+" low stock",dot:"danger",tab:"kits"});var d=e?(e.upcomingAppointments||[]).length:0;if(d>0){var l=e.upcomingAppointments[0],u=d+" upcoming appointment"+(1!==d?"s":"");0===l.daysAway?u="Appointment today":1===l.daysAway&&(u="Appointment tomorrow + "+(d-1)+" more"),n.push({text:u,dot:"info",tab:"scheduling"})}var m=e&&e.pendingHolds||0;if(e||c.forEach(function(e){"pending"===(e.status||"").toLowerCase().trim()&&m++}),m>0&&n.push({text:m+" hold"+(1!==m?"s":"")+" to confirm",dot:"warning",tab:"reservations",filter:"pending"}),0!==n.length){var f="";n.forEach(function(e){f+='<div class="attention-item" data-tab="'+e.tab+'"'+(e.filter?' data-filter="'+e.filter+'"':"")+">",f+='<span class="attention-dot attention-dot--'+e.dot+'"></span>',f+=e.text,f+="</div>"}),t.innerHTML=f,t.querySelectorAll(".attention-item").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-tab"),n=e.getAttribute("data-filter");if(t&&document.querySelector('[data-tab="'+t+'"]').click(),n){var a=document.getElementById("res-status-filter");a&&(a.value=n,a.dispatchEvent(new Event("change")))}})})}else t.innerHTML='<div class="attention-item"><span class="attention-dot attention-dot--success"></span>All clear — nothing needs attention</div>'}}function k(){"undefined"!=typeof google&&google.accounts&&google.accounts.oauth2?function(){n=google.accounts.oauth2.initTokenClient({client_id:SHEETS_CONFIG.CLIENT_ID,scope:SHEETS_CONFIG.SCOPES+" https://www.googleapis.com/auth/userinfo.email",callback:C});var e=document.getElementById("google-signin-btn");if(e){var t=document.createElement("button");t.type="button",t.className="btn",t.textContent="Sign in with Google",t.addEventListener("click",function(){n.requestAccessToken()}),e.appendChild(t)}document.getElementById("admin-signout").addEventListener("click",x),document.getElementById("admin-signout-denied").addEventListener("click",x)}():setTimeout(k,100)}function C(n){n.error?localStorage.removeItem("sv-admin-email"):(e=n.access_token,fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:"Bearer "+e}}).then(function(e){return e.json()}).then(function(e){t=e.email,function(){if(console.log("[Admin] Checking authorization for:",t),SHEETS_CONFIG.ADMIN_API_URL)return console.log("[Admin] Using server-side auth validation"),void T("check_auth").then(function(e){console.log("[Admin] Server auth result:",e),e.authorized?_():w()}).catch(function(e){console.error("[Admin] Server auth failed:",e.message),w()});console.warn("[Admin] Using client-side auth (ADMIN_API_URL not configured)"),L(SHEETS_CONFIG.SHEET_NAMES.CONFIG+"!A:B").then(function(e){var n=e.values||[];console.log("[Admin] Config sheet rows:",JSON.stringify(n));for(var o=0;o<n.length;o++)if("staff_emails"===n[o][0]){a=(n[o][1]||"").split(",").map(function(e){return e.trim().toLowerCase()});break}console.log("[Admin] Parsed staff emails:",a),console.log("[Admin] User email match:",-1!==a.indexOf(t.toLowerCase())),-1!==a.indexOf(t.toLowerCase())?_():w()}).catch(function(e){console.error("[Admin] Failed to read Config sheet:",e),w()})}()}).catch(function(){w()}))}function _(){document.getElementById("admin-signin").style.display="none",document.getElementById("admin-denied").style.display="none",document.getElementById("admin-dashboard").style.display="",document.getElementById("admin-user-email").textContent=t;var e=document.getElementById("admin-signout");e&&(e.style.display=""),localStorage.setItem("sv-admin-email",t),B(),fetch("content/email-templates.json").then(function(e){return e.json()}).then(function(e){z=e}).catch(function(){z=null}),setInterval(function(){n.requestAccessToken({prompt:""})},3e6)}function w(){document.getElementById("admin-signin").style.display="none",document.getElementById("admin-denied").style.display="",document.getElementById("admin-dashboard").style.display="none"}function x(){e&&google.accounts.oauth2.revoke(e),e=null,t=null,localStorage.removeItem("sv-admin-email"),document.getElementById("admin-signin").style.display="",document.getElementById("admin-denied").style.display="none",document.getElementById("admin-dashboard").style.display="none";var n=document.getElementById("admin-signout");n&&(n.style.display="none"),document.getElementById("admin-user-email").textContent=""}function N(e,t,n){return void 0===n&&(n=1),fetch(e,t).catch(function(a){if(n>0)return new Promise(function(e){setTimeout(e,1e3)}).then(function(){return N(e,t,n-1)});throw a})}function T(t,n){if(!SHEETS_CONFIG.ADMIN_API_URL)return Promise.reject(new Error("Admin API not configured"));var a=SHEETS_CONFIG.ADMIN_API_URL+"?action="+encodeURIComponent(t)+"&token="+encodeURIComponent(e);return n&&Object.keys(n).forEach(function(e){a+="&"+encodeURIComponent(e)+"="+encodeURIComponent(n[e])}),N(a,{method:"GET"}).then(function(e){return e.json()}).then(function(e){if(!e.ok)throw new Error(e.message||e.error||"API error");return e})}function A(t,n){return SHEETS_CONFIG.ADMIN_API_URL?(n.action=t,n.token=e,N(SHEETS_CONFIG.ADMIN_API_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(n)}).then(function(e){return e.json()}).then(function(e){if(!e.ok)throw new Error(e.message||e.error||"API error");return e})):Promise.reject(new Error("Admin API not configured"))}function L(t){return N("https://sheets.googleapis.com/v4/spreadsheets/"+SHEETS_CONFIG.SPREADSHEET_ID+"/values/"+encodeURIComponent(t),{headers:{Authorization:"Bearer "+e}}).then(function(e){if(!e.ok)throw new Error("Sheets API error: "+e.status);return e.json()})}function O(t,n){return(SHEETS_CONFIG.ADMIN_API_URL?T("check_auth").then(function(e){if(!e.authorized)throw new Error("Not authorized to make changes")}):Promise.resolve()).then(function(){return N("https://sheets.googleapis.com/v4/spreadsheets/"+SHEETS_CONFIG.SPREADSHEET_ID+"/values/"+encodeURIComponent(t)+"?valueInputOption=USER_ENTERED",{method:"PUT",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json"},body:JSON.stringify({values:n})}).then(function(e){if(!e.ok)throw new Error("Sheets API error: "+e.status);return e.json()})})}function H(t,n){return(SHEETS_CONFIG.ADMIN_API_URL?T("check_auth").then(function(e){if(!e.authorized)throw new Error("Not authorized to make changes")}):Promise.resolve()).then(function(){return N("https://sheets.googleapis.com/v4/spreadsheets/"+SHEETS_CONFIG.SPREADSHEET_ID+"/values/"+encodeURIComponent(t)+":append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS",{method:"POST",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json"},body:JSON.stringify({values:n})}).then(function(e){if(!e.ok)throw new Error("Sheets API error: "+e.status);return e.json()})})}function B(){g.offset=0,g.currentFilter=document.getElementById("res-status-filter")?.value||"pending",SHEETS_CONFIG.ADMIN_API_URL?Promise.all([T("get_kits"),M(),T("get_holds"),T("get_schedule"),T("get_dashboard_summary")]).then(function(e){return P(e[0].data,"kits"),P(e[2].data,"holds"),P(e[3].data,"schedule"),p=e[4].data||null,L(SHEETS_CONFIG.SHEET_NAMES.INGREDIENTS+"!A:Z")}).then(function(e){P(e,"ingredients"),F()}).catch(function(e){console.error("Failed to load data via Admin API:",e),y("Failed to load data: "+e.message,"error")}):Promise.all([L(SHEETS_CONFIG.SHEET_NAMES.KITS+"!A:Z"),L(SHEETS_CONFIG.SHEET_NAMES.INGREDIENTS+"!A:Z"),L(SHEETS_CONFIG.SHEET_NAMES.RESERVATIONS+"!A:Z"),L(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!A:Z"),L(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!A:Z")]).then(function(e){P(e[0],"kits"),P(e[1],"ingredients"),P(e[2],"reservations"),P(e[3],"holds"),P(e[4],"schedule"),g.total=s.length,g.filtered=s.length,F()}).catch(function(e){console.error("Failed to load data:",e)})}function M(){return SHEETS_CONFIG.ADMIN_API_URL?T("get_reservations",{limit:g.limit,offset:g.offset,status:g.currentFilter}).then(function(e){return P(e.data,"reservations"),g.total=e.data.total||0,g.filtered=e.data.filtered||0,e}):Promise.resolve({data:{values:[]}})}function D(e){var t=g.offset+e*g.limit;t<0&&(t=0),t>=g.filtered||(g.offset=t,M().then(function(){U()}).catch(function(e){console.error("Failed to load reservations page:",e)}))}function F(){q(),U(),X(),re(),function(){we(),Le||(Le=new Date).setDate(1);He()}(),function(){var e=document.getElementById("kit-brand-filter");if(!e)return;var t=[];o.forEach(function(e){e.brand&&-1===t.indexOf(e.brand)&&t.push(e.brand)}),t.sort();for(;e.options.length>1;)e.remove(1);t.forEach(function(t){var n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)})}(),ye=o.map(function(e){return{sku:e.sku||"",brand:e.brand||"",name:e.name||"",label:(e.brand||"")+" — "+(e.name||"")+" ("+(e.sku||"")+")"}}),function(){if(0===o.length)return;var e=[];o.forEach(function(t){var n=parseInt(t.on_order,10)||0;n>0&&t.sku&&e.push({sku:t.sku,brand:t.brand||"",name:t.name||"",qty:n})}),e.length>0&&(me(e),le(),ge(),console.log("[Admin] Loaded "+e.length+" item(s) from sheet on_order column"))}(),le(),ge(),L(SHEETS_CONFIG.SHEET_NAMES.HOMEPAGE+"!A:E").then(function(e){var t=e.values||[];t.length>0&&t[0],Ve["promo-news"]=[],Ve["promo-featured-skus"]=[],Ve["social-instagram"]="",Ve["social-facebook"]="",Ve.faq=[];for(var n=1;n<t.length;n++){var a=t[n],o=(a[0]||"").toLowerCase();if("news"===o)Ve["promo-news"].push({date:a[1]||"",title:a[2]||"",text:a[3]||""});else if("featured"===o){var r=a[4]||"",i=a[3]||"";r&&Ve["promo-featured-skus"].push({sku:r,description:i})}else if("instafeed"===o)Ve["instafeed-url"]=a[3]||"";else if("social"===o){var d=(a[2]||"").toLowerCase().trim(),s=a[4]||"";"instagram"===d?Ve["social-instagram"]=s:"facebook"===d&&(Ve["social-facebook"]=s)}else"faq"===o&&Ve.faq.push({question:a[2]||"",answer:a[3]||""})}We(),Ye(),Je();var l=document.getElementById("homepage-instafeed-url");l&&(l.value=Ve["instafeed-url"]||"");var c=document.getElementById("homepage-social-instagram");c&&(c.value=Ve["social-instagram"]||"");var u=document.getElementById("homepage-social-facebook");u&&(u.value=Ve["social-facebook"]||"")}).catch(function(e){console.error("[Homepage] Error loading from sheet:",e)})}function q(){p?function(e){document.getElementById("dash-reservations-today").textContent=e.reservationsToday||0,document.getElementById("dash-reservations-week").textContent=e.totalActiveReservations+" active total";var t=e.pendingReservations||0,n=e.readyReservations||0,a=e.pendingHolds||0,o=t+n+a;document.getElementById("dash-pending-actions").textContent=o;var r=[];t>0&&r.push(t+" to confirm");n>0&&r.push(n+" ready for pickup");a>0&&r.push(a+" hold"+(1!==a?"s":""));document.getElementById("dash-pending-detail").textContent=r.join(", ")||"No pending actions";var i=e.lowStockKits||[];document.getElementById("dash-low-stock").textContent=i.length;var d=document.querySelector(".dashboard-card--stock .dashboard-card-value");if(0===i.length)document.getElementById("dash-low-stock-detail").textContent="All items well stocked",d&&(d.style.color="#388e3c");else{d&&(d.style.color="");var s=i.slice(0,2).map(function(e){return e.name+" ("+e.stock+")"}).join(", ");i.length>2&&(s+=" +"+(i.length-2)+" more"),document.getElementById("dash-low-stock-detail").innerHTML=s+' <a id="dash-low-stock-link">View all</a>',document.getElementById("dash-low-stock-link").addEventListener("click",function(){document.querySelector('[data-tab="kits"]').click()})}var l=e.upcomingAppointments||[];if(document.getElementById("dash-upcoming-appts").textContent=l.length,l.length>0){var c=l[0],u="Next: "+c.date;0===c.daysAway?u="Today: "+c.name:1===c.daysAway&&(u="Tomorrow: "+c.name),document.getElementById("dash-upcoming-detail").textContent=u}else document.getElementById("dash-upcoming-detail").textContent="None in next 7 days";S(null),I(e)}(p):function(){var e=new Date,t=e.toISOString().split("T")[0],n=new Date(e);n.setDate(n.getDate()-7);var a=new Date(e);a.setDate(a.getDate()+7);var r=0,i=0;s.forEach(function(e){var a=e.submitted_at||"";a.split("T")[0]===t&&r++,a&&new Date(a)>=n&&i++}),document.getElementById("dash-reservations-today").textContent=r,document.getElementById("dash-reservations-week").textContent=i+" this week";var d=0,l=0,u=0;s.forEach(function(e){var t=(e.status||"").toLowerCase().trim()||"pending";"pending"===t&&d++,"ready"===t&&l++}),c.forEach(function(e){"pending"===((e.status||"").toLowerCase().trim()||"pending")&&u++});var m=d+l+u;document.getElementById("dash-pending-actions").textContent=m;var f=[];d>0&&f.push(d+" to confirm");l>0&&f.push(l+" ready for pickup");u>0&&f.push(u+" hold"+(1!==u?"s":""));document.getElementById("dash-pending-detail").textContent=f.join(", ")||"No pending actions";var p=3,v=[];if(o.forEach(function(e){var t=parseInt(e.stock,10)||0,n=parseInt(e.on_hold,10)||0,a=t-n;"true"!==e.hide&&"TRUE"!==e.hide&&a<=p&&v.push({name:e.name,brand:e.brand,available:a,stock:t,onHold:n})}),document.getElementById("dash-low-stock").textContent=v.length,0===v.length)document.getElementById("dash-low-stock-detail").textContent="All items well stocked",document.querySelector(".dashboard-card--stock .dashboard-card-value").style.color="#388e3c";else{var h=v.slice(0,2).map(function(e){return(e.brand?e.brand+" ":"")+e.name+" ("+e.available+")"}).join(", ");v.length>2&&(h+=" +"+(v.length-2)+" more"),document.getElementById("dash-low-stock-detail").innerHTML=h+' <a id="dash-low-stock-link">View all</a>',document.getElementById("dash-low-stock-link").addEventListener("click",function(){document.querySelector('[data-tab="kits"]').click()})}var E=0,g=null,y=["pending","confirmed","brewing"];if(s.forEach(function(t){var n=(t.status||"").toLowerCase().trim()||"pending";if(-1!==y.indexOf(n)){var o=function(e){if(!e)return null;var t=e.match(/(\w+)\s+(\w+)\s+(\d+)/);if(t){var n=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],a=t[2].toLowerCase().substring(0,3),o=n.indexOf(a),r=parseInt(t[3],10);if(-1!==o&&r){var i=(new Date).getFullYear(),d=new Date(i,o,r);return d<new Date&&d.setFullYear(i+1),d}}var s=e.match(/(\d{4})-(\d{2})-(\d{2})/);if(s)return new Date(s[1],parseInt(s[2],10)-1,s[3]);var l=new Date(e);if(!isNaN(l.getTime()))return l;return null}(t.timeslot||"");o&&o>=e&&o<=a&&(E++,(!g||o<g)&&(g=o))}}),document.getElementById("dash-upcoming-appts").textContent=E,E>0&&g){var b=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][g.getDay()],k=g.toLocaleDateString("en-US",{month:"short",day:"numeric"});document.getElementById("dash-upcoming-detail").textContent="Next: "+b+" "+k}else document.getElementById("dash-upcoming-detail").textContent="None in next 7 days";S(null),I(null)}()}function P(e,t){var n=e.values||[];if(0!==n.length){for(var a=n[0],p=[],v=1;v<n.length;v++){for(var h={},E=0;E<a.length;E++)h[a[E]]=n[v][E]||"";h._rowIndex=v+1,p.push(h)}switch(t){case"kits":r=a,o=p;break;case"ingredients":d=a,i=p;break;case"reservations":l=a,s=p;break;case"holds":u=a,c=p;break;case"schedule":f=a,m=p}}}function R(e,t){document.getElementById("admin-modal-title").textContent=e,document.getElementById("admin-modal-body").innerHTML=t,document.getElementById("admin-modal").style.display=""}function G(){document.getElementById("admin-modal").style.display="none"}function U(){var e=document.getElementById("reservations-tbody"),n=document.getElementById("reservations-empty");if(e){var a=document.getElementById("res-status-filter").value,i=s;if(SHEETS_CONFIG.ADMIN_API_URL||((i="all"===a?s:"active"===a?s.filter(function(e){var t=(e.status||"").toLowerCase().trim();return t||(t="pending"),"archived"!==t}):s.filter(function(e){var t=(e.status||"").toLowerCase().trim();return t||(t="pending"),t===a})).sort(function(e,t){return(t.submitted_at||"").localeCompare(e.submitted_at||"")}),g.filtered=i.length),e.innerHTML="",0===i.length)return n.style.display="",document.getElementById("reservations-table").style.display="none",void K();n.style.display="none",document.getElementById("reservations-table").style.display="",i.forEach(function(n){var a=c.filter(function(e){return e.reservation_id===n.reservation_id}),i=document.createElement("tr");i.className="admin-res-row";var d=document.createElement("td"),s=document.createElement("button");s.type="button",s.className="admin-expand-btn",s.textContent=a.length>0?"+":"",s.setAttribute("aria-expanded","false"),d.appendChild(s),i.appendChild(d),j(i,n.reservation_id);var m=document.createElement("td"),f=document.createElement("span");if(f.className="res-cell-primary",f.textContent=n.customer_name||"",m.appendChild(f),n.customer_email){var p=document.createElement("span");p.className="res-cell-secondary",p.textContent=n.customer_email,m.appendChild(p)}if(n.customer_phone){var v=document.createElement("span");v.className="res-cell-secondary",v.textContent=n.customer_phone,m.appendChild(v)}i.appendChild(m);var g=document.createElement("td");(n.products||"").split(",").forEach(function(e,t){var n=e.trim();if(n){var a=document.createElement("span");a.className="res-cell-line",a.textContent=n,g.appendChild(a)}}),i.appendChild(g);var b=document.createElement("td"),S=(n.timeslot||"").trim(),I=S.indexOf(" ");if(I>0){var k=document.createElement("span");k.className="res-cell-primary",k.textContent=S.substring(0,I),b.appendChild(k);var C=document.createElement("span");C.className="res-cell-secondary",C.textContent=S.substring(I+1),b.appendChild(C)}else b.textContent=S;i.appendChild(b);var _=document.createElement("td"),w=document.createElement("span"),x=(n.status||"").trim().toLowerCase()||"pending";h[x]||(x="pending"),w.className="hold-badge hold-badge--"+x,w.textContent=h[x].label,w.title=h[x].description,_.appendChild(w),i.appendChild(_),j(i,n.submitted_at||"");var N,T=document.createElement("td");if(T.className="res-actions",n.customer_email){var L=document.createElement("button");L.type="button",L.className="btn admin-btn-sm",L.textContent="Email",L.addEventListener("click",(N=n,function(){Y(N)})),T.appendChild(L)}var H=E[x]||[];if(H.length>0){var M=document.createElement("select");M.className="admin-select admin-status-select";var D=document.createElement("option");D.value="",D.textContent="Change status...",M.appendChild(D),H.forEach(function(e){var t=document.createElement("option");t.value=e,t.textContent="→ "+h[e].label,M.appendChild(t)}),M.addEventListener("change",function(e,t,n){return function(){var a=this.value;if(a){var o='Change status to "'+h[a].label+'"';o+="cancelled"===a?"? This will cancel the reservation.":"archived"===a?"? It will be hidden from the active list.":"?",confirm(o)?(function(e,t){var n=l.indexOf("status");if(-1===n)return void y("Cannot find status column.","warning");if(SHEETS_CONFIG.ADMIN_API_URL)return void A("update_reservation",{reservationId:e.reservation_id,expectedVersion:e.last_updated||null,updates:{status:t}}).then(function(n){e.status=t,n.newVersion&&(e.last_updated=n.newVersion),U(),q()}).catch(function(e){e.message&&-1!==e.message.indexOf("modified by another user")?confirm(e.message+"\n\nWould you like to refresh the data now?")&&B():y("Failed to update reservation: "+e.message,"error")});var a=SHEETS_CONFIG.SHEET_NAMES.RESERVATIONS+"!"+Qe(n)+e._rowIndex;O(a,[[t]]).then(function(){e.status=t;var n=l.indexOf("last_updated");if(-1!==n){var a=(new Date).toISOString();O(SHEETS_CONFIG.SHEET_NAMES.RESERVATIONS+"!"+Qe(n)+e._rowIndex,[[a]]),e.last_updated=a}U(),q()}).catch(function(e){y("Failed to update reservation: "+e.message,"error")})}(e,a),"confirmed"===a&&"pending"===n&&t.length>0&&function(e,t){var n=t.filter(function(e){return"pending"===(e.status||"").toLowerCase()});if(0===n.length)return;var a=Promise.resolve();n.forEach(function(t){a=a.then(function(){return new Promise(function(n){V(t,e),setTimeout(n,200)})})})}(e,t)):this.value=""}}}(n,a,x)),T.appendChild(M)}i.appendChild(T),e.appendChild(i);var F,P,R=[];a.forEach(function(a){var i=document.createElement("tr");i.className="admin-hold-row",i.style.display="none",j(i,""),j(i,a.hold_id||"");var d=document.createElement("td"),s=document.createElement("span");if(s.className="res-cell-primary",s.textContent=a.product_name||"",d.appendChild(s),a.sku){var l=document.createElement("span");l.className="res-cell-secondary",l.textContent="SKU: "+a.sku,d.appendChild(l)}i.appendChild(d),j(i,"Qty: "+(a.qty||"")),j(i,"");var c=document.createElement("td"),m=document.createElement("span");m.className="hold-badge hold-badge--"+(a.status||"pending").toLowerCase(),m.textContent=a.status||"pending",c.appendChild(m),i.appendChild(c),j(i,a.created_at||"");var f,p,v=document.createElement("td");if("pending"===(a.status||"").toLowerCase()){var h=document.createElement("button");h.type="button",h.className="btn admin-btn-sm",h.textContent="Confirm",h.addEventListener("click",(f=a,p=n,function(){V(f,p)})),v.appendChild(h);var E=document.createElement("button");E.type="button",E.className="btn-secondary admin-btn-sm",E.textContent="Release",E.addEventListener("click",function(e,n){return function(){!function(e,n){var a=parseInt(e.qty,10)||0,i=e._rowIndex,d=o.find(function(t){return t.sku===e.sku});if(SHEETS_CONFIG.ADMIN_API_URL){var s=(new Date).toISOString();return void A("update_hold",{holdId:e.hold_id,expectedVersion:e.last_updated||null,updates:{status:"released",resolved_at:s,resolved_by:t}}).then(function(n){if(e.status="released",e.resolved_at=s,e.resolved_by=t,n.newVersion&&(e.last_updated=n.newVersion),d)return function(e,t){var n=r.indexOf("on_hold");if(-1!==n){var a=Math.max(0,(parseInt(e.on_hold,10)||0)-t),o=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+Qe(n)+e._rowIndex;return e.on_hold=String(a),O(o,[[a]])}return Promise.resolve()}(d,a)}).then(function(){$(n),U(),X(),q()}).catch(function(e){e.message&&-1!==e.message.indexOf("modified by another user")?confirm(e.message+"\n\nWould you like to refresh the data now?")&&B():y("Failed to release hold: "+e.message,"error")})}var l=[],c=u.indexOf("status"),m=u.indexOf("resolved_at"),f=u.indexOf("resolved_by"),p=u.indexOf("last_updated");-1!==c&&l.push(O(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+Qe(c)+i,[["released"]]));-1!==m&&l.push(O(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+Qe(m)+i,[[(new Date).toISOString()]]));-1!==f&&l.push(O(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+Qe(f)+i,[[t]]));-1!==p&&l.push(O(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+Qe(p)+i,[[(new Date).toISOString()]]));if(d){var v=r.indexOf("on_hold");if(-1!==v){var h=Math.max(0,(parseInt(d.on_hold,10)||0)-a);l.push(O(SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+Qe(v)+d._rowIndex,[[h]])),d.on_hold=String(h)}}Promise.all(l).then(function(){e.status="released",e.resolved_at=(new Date).toISOString(),e.resolved_by=t,e.last_updated=(new Date).toISOString(),$(n),U(),X(),q()}).catch(function(e){y("Failed to release hold: "+e.message,"error")})}(e,n)}}(a,n)),v.appendChild(E)}i.appendChild(v),R.push(i),e.appendChild(i)}),s.addEventListener("click",(F=R,P=s,function(){var e="true"===P.getAttribute("aria-expanded");P.setAttribute("aria-expanded",String(!e)),P.textContent=e?"+":"−",F.forEach(function(t){t.style.display=e?"none":""})}))}),K()}}function K(){var e=document.getElementById("reservations-pagination");if(e){var t=g.filtered,n=g.limit,a=g.offset,o=Math.ceil(t/n),r=Math.floor(a/n)+1;if(o<=1)e.innerHTML=t>0?'<span class="pagination-info">'+t+" reservation"+(1!==t?"s":"")+"</span>":"";else{var i='<div class="pagination-controls">';i+='<button type="button" class="btn-secondary pagination-btn" '+(r<=1?"disabled":"")+' data-page="prev">&larr; Previous</button>',i+='<span class="pagination-info">'+(a+1)+"–"+Math.min(a+n,t)+" of "+t+"</span>",i+='<button type="button" class="btn-secondary pagination-btn" '+(r>=o?"disabled":"")+' data-page="next">Next &rarr;</button>',i+="</div>",e.innerHTML=i,e.querySelectorAll(".pagination-btn").forEach(function(e){e.addEventListener("click",function(){var e=this.getAttribute("data-page");"prev"===e?D(-1):"next"===e&&D(1)})})}}}function j(e,t){var n=document.createElement("td");n.textContent=t,e.appendChild(n)}function V(e,n){var a=parseInt(e.qty,10)||0,i=e._rowIndex,d=o.find(function(t){return t.sku===e.sku});if(SHEETS_CONFIG.ADMIN_API_URL){var s=(new Date).toISOString();A("update_hold",{holdId:e.hold_id,expectedVersion:e.last_updated||null,updates:{status:"confirmed",resolved_at:s,resolved_by:t}}).then(function(n){if(e.status="confirmed",e.resolved_at=s,e.resolved_by=t,n.newVersion&&(e.last_updated=n.newVersion),d)return function(e,t){var n=[],a=r.indexOf("stock"),o=r.indexOf("on_hold");if(-1!==a){var i=Math.max(0,(parseInt(e.stock,10)||0)-t),d=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+Qe(a)+e._rowIndex;n.push(O(d,[[i]])),e.stock=String(i)}if(-1!==o){var s=Math.max(0,(parseInt(e.on_hold,10)||0)-t),l=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+Qe(o)+e._rowIndex;n.push(O(l,[[s]])),e.on_hold=String(s)}return Promise.all(n)}(d,a)}).then(function(){$(n),U(),X(),q()}).catch(function(e){e.message&&-1!==e.message.indexOf("modified by another user")?confirm(e.message+"\n\nWould you like to refresh the data now?")&&B():y("Failed to confirm hold: "+e.message,"error")})}else{var l=[],c=u.indexOf("status"),m=u.indexOf("resolved_at"),f=u.indexOf("resolved_by"),p=u.indexOf("last_updated");if(-1!==c){var v=SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+Qe(c)+i;l.push(O(v,[["confirmed"]]))}if(-1!==m){var h=SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+Qe(m)+i;l.push(O(h,[[(new Date).toISOString()]]))}if(-1!==f){var E=SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+Qe(f)+i;l.push(O(E,[[t]]))}if(-1!==p){var g=SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+Qe(p)+i;l.push(O(g,[[(new Date).toISOString()]]))}if(d){var b=r.indexOf("stock"),S=r.indexOf("on_hold");if(-1!==b){var I=Math.max(0,(parseInt(d.stock,10)||0)-a),k=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+Qe(b)+d._rowIndex;l.push(O(k,[[I]])),d.stock=String(I)}if(-1!==S){var C=Math.max(0,(parseInt(d.on_hold,10)||0)-a),_=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+Qe(S)+d._rowIndex;l.push(O(_,[[C]])),d.on_hold=String(C)}}Promise.all(l).then(function(){e.status="confirmed",e.resolved_at=(new Date).toISOString(),e.resolved_by=t,e.last_updated=(new Date).toISOString(),$(n),U(),X(),q()}).catch(function(e){y("Failed to confirm hold: "+e.message,"error")})}}function $(e){var t=c.filter(function(t){return t.reservation_id===e.reservation_id});if(0!==t.length){var n=t.every(function(e){return"confirmed"===e.status}),a=t.every(function(e){return"released"===e.status}),o=t.every(function(e){return"confirmed"===e.status||"released"===e.status}),r=null;if(n?r="confirmed":a?r="cancelled":o&&(r="confirmed"),r&&e.status!==r){var i="confirmed"!==e.status;if(e.status=r,SHEETS_CONFIG.ADMIN_API_URL)A("update_reservation",{reservationId:e.reservation_id,expectedVersion:null,updates:{status:r}}).then(function(t){t.newVersion&&(e.last_updated=t.newVersion)}).catch(function(e){console.error("Failed to auto-update reservation status:",e)});else{var d=l.indexOf("status");if(-1!==d){O(SHEETS_CONFIG.SHEET_NAMES.RESERVATIONS+"!"+Qe(d)+e._rowIndex,[[r]]);var s=l.indexOf("last_updated");if(-1!==s){var u=(new Date).toISOString();O(SHEETS_CONFIG.SHEET_NAMES.RESERVATIONS+"!"+Qe(s)+e._rowIndex,[[u]]),e.last_updated=u}}}"confirmed"===r&&i&&e.customer_email&&Y(e)}}}document.addEventListener("DOMContentLoaded",function(){var e=document.querySelector(".nav-toggle"),t=document.querySelector(".nav-list");e&&t&&e.addEventListener("click",function(){t.classList.toggle("open")});var n,a,r=document.body.getAttribute("data-page");r&&fetch("content/"+r+".json").then(function(e){return e.json()}).then(function(e){document.querySelectorAll("[data-content]").forEach(function(t){var n=t.getAttribute("data-content");void 0!==e[n]&&(t.textContent=e[n])})}).catch(function(){}),(n=document.querySelectorAll(".admin-tab-btn")).forEach(function(e){e.addEventListener("click",function(){n.forEach(function(e){e.classList.remove("active")}),e.classList.add("active"),document.querySelectorAll(".admin-tab-panel").forEach(function(e){e.classList.remove("active")});var t=document.getElementById("tab-"+e.getAttribute("data-tab"));t&&t.classList.add("active")})}),function(){var e=document.getElementById("admin-modal"),t=document.getElementById("admin-modal-overlay"),n=document.getElementById("admin-modal-close");function a(){e.style.display="none"}t&&t.addEventListener("click",a);n&&n.addEventListener("click",a)}(),document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("export-kits-btn");e&&e.addEventListener("click",De);var t=document.getElementById("export-ingredients-btn");t&&t.addEventListener("click",Fe);var n=document.getElementById("export-ws-btn");n&&n.addEventListener("click",qe)}),document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("import-csv-input");e&&e.addEventListener("change",Ge);var t=document.getElementById("import-apply-btn");t&&t.addEventListener("click",Ue);var n=document.getElementById("import-cancel-btn");n&&n.addEventListener("click",Ke)}),function(){var e=document.getElementById("res-status-filter");e&&e.addEventListener("change",function(){g.offset=0,g.currentFilter=this.value,SHEETS_CONFIG.ADMIN_API_URL?M().then(function(){U()}).catch(function(e){console.error("Failed to load filtered reservations:",e)}):U()});var t,n=document.getElementById("kit-search");n&&n.addEventListener("input",function(){clearTimeout(t),t=setTimeout(X,300)});var a=document.getElementById("kit-brand-filter");a&&a.addEventListener("change",X);var o=document.getElementById("kit-stock-filter");o&&o.addEventListener("change",X);!function(){var e=document.querySelector("#kits-table thead tr");if(!e)return;e.querySelectorAll("th").forEach(function(e){var t=e.textContent.trim(),n=Z[t];n&&(e.className="sortable",e.setAttribute("data-sort-key",n),n===J&&e.classList.add("asc"===Q?"sort-asc":"sort-desc"),e.addEventListener("click",function(){J===n?Q="asc"===Q?"desc":"asc":(J=n,Q="asc"),X()}))})}();var r=document.getElementById("ing-type-filter");r&&r.addEventListener("change",re);!function(){var e,t=document.getElementById("order-search");t&&t.addEventListener("input",function(){clearTimeout(e),e=setTimeout(ge,300)});var n=document.getElementById("order-brand-filter");n&&n.addEventListener("change",ge);!function(){var e=document.querySelector("#order-table thead tr");if(!e)return;e.querySelectorAll("th").forEach(function(e){var t=e.textContent.trim(),n=se[t];n&&(e.className="sortable",e.setAttribute("data-sort-key",n),n===ie&&e.classList.add("asc"===de?"sort-asc":"sort-desc"),e.addEventListener("click",function(){ie===n?de="asc"===de?"desc":"asc":(ie=n,de="asc"),ge()}))})}()}()}(),function(){var e=document.getElementById("admin-save-btn"),t=document.getElementById("admin-discard-btn");e&&e.addEventListener("click",ae);t&&t.addEventListener("click",oe)}(),function(){!function(){var e=document.getElementById("order-kit-search"),t=document.getElementById("order-kit-dropdown"),n=document.getElementById("order-kit-select");if(!e||!t||!n)return;var a=-1;function o(e){console.log("[Order] renderDropdown called, query:",e,"options count:",ye.length);var n=(e||"").toLowerCase(),o=ye.filter(function(e){return!n||-1!==e.label.toLowerCase().indexOf(n)});console.log("[Order] matches:",o.length),t.innerHTML="",a=-1,0!==o.length?(o.forEach(function(e,n){var a=document.createElement("div");a.className="admin-kit-search-option",a.textContent=e.label,a.setAttribute("data-index",n),a.addEventListener("mousedown",function(t){t.preventDefault(),r(e)}),t.appendChild(a)}),t.style.display="block"):t.style.display="none"}function r(a){e.value=a.label,n.value=a.sku,n.setAttribute("data-brand",a.brand),n.setAttribute("data-name",a.name),t.style.display="none";var o=document.getElementById("order-kit-qty");o&&pe(a.brand)?(o.value="2",o.step="2",o.min="2"):o&&(o.value="1",o.step="1",o.min="1")}function i(e){var n=t.querySelectorAll(".admin-kit-search-option");n.forEach(function(e){e.classList.remove("active")}),e>=0&&e<n.length&&(n[e].classList.add("active"),n[e].scrollIntoView({block:"nearest"}))}e.addEventListener("focus",function(){n.value="",o(e.value)}),e.addEventListener("input",function(){n.value="",o(e.value)}),e.addEventListener("blur",function(){setTimeout(function(){t.style.display="none"},150)}),e.addEventListener("keydown",function(n){var o=t.querySelectorAll(".admin-kit-search-option");if("ArrowDown"===n.key)n.preventDefault(),i(a=Math.min(a+1,o.length-1));else if("ArrowUp"===n.key)n.preventDefault(),i(a=Math.max(a-1,0));else if("Enter"===n.key){if(n.preventDefault(),a>=0&&a<o.length){var d=(e.value||"").toLowerCase(),s=ye.filter(function(e){return!d||-1!==e.label.toLowerCase().indexOf(d)});s[a]&&r(s[a])}}else"Escape"===n.key&&(t.style.display="none",e.blur())})}();var e=document.getElementById("order-add-btn");e&&e.addEventListener("click",function(){var e=document.getElementById("order-kit-select"),t=document.getElementById("order-kit-search"),n=document.getElementById("order-kit-qty"),a=e.value;if(a){var o=parseInt(n.value,10)||1;he(a,e.getAttribute("data-brand")||"",e.getAttribute("data-name")||"",o),e.value="",t.value="",n.value="1"}else y("Type and select a kit first.","warning")});var t=document.getElementById("order-copy-btn");t&&t.addEventListener("click",be);var n=document.getElementById("order-accept-btn");n&&n.addEventListener("click",Se);var a=document.getElementById("order-clear-btn");a&&a.addEventListener("click",Ie);var r=document.getElementById("order-import-btn"),i=document.getElementById("order-import-file");r&&i&&(r.addEventListener("click",function(){i.click()}),i.addEventListener("change",function(){var e,t;i.files.length>0&&(e=i.files[0],(t=new FileReader).onload=function(e){var t=e.target.result.split(/\r?\n/).filter(function(e){return""!==e.trim()});if(t.length<2)y("CSV must have a header row and at least one data row.","warning");else{var n=je(t[0]).map(function(e){return e.trim().toLowerCase()}),a=n.indexOf("sku"),r=n.indexOf("qty");if(-1!==a&&-1!==r){for(var i=0,d=[],s=1;s<t.length;s++){var l=je(t[s]),c=(l[a]||"").trim(),u=parseInt(l[r],10);if(!(!c||isNaN(u)||u<=0)){var m=o.find(function(e){return e.sku===c});m?(he(c,m.brand,m.name,u),i++):d.push(c)}}var f=i+" item(s) added to order.";d.length>0&&(f+="\n"+d.length+" skipped (unrecognized SKUs: "+d.join(", ")+")"),y(f,"success")}else y('CSV must have "SKU" and "Qty" columns.',"warning")}},t.readAsText(e)),i.value=""}))}(),(a=document.getElementById("schedule-save-defaults-btn"))&&a.addEventListener("click",function(){_e(function(){var e=document.getElementById("schedule-defaults-tbody");if(!e)return Ce();var t=Ce();return e.querySelectorAll("select").forEach(function(e){var n=parseInt(e.dataset.idx,10),a=e.dataset.field;t[n][a]=e.value,t[n].start&&t[n].end&&(t[n].open=!0)}),t}()),y("Default schedule saved.","success")}),k(),ge()});var z=null;function W(e,t){var n=e;return Object.keys(t).forEach(function(e){n=n.replace(new RegExp("\\{\\{"+e+"\\}\\}","g"),t[e])}),n}function Y(e){var t={customer:e.customer_name||"Customer",email:e.customer_email||"",products:e.products||"",timeslot:e.timeslot||""};function n(e,n){window.open("mailto:"+encodeURIComponent(t.email)+"?subject="+encodeURIComponent(e)+"&body="+encodeURIComponent(n),"_blank")}if(z&&z.confirmation){var a=z.confirmation;n(W(a.subject,t),W(a.body,t))}else n("Your Steins & Vines Reservation is Confirmed","Hi "+t.customer+",\n\nGreat news! Your reservation has been confirmed.\n\nReserved items: "+t.products+"\nAppointment: "+t.timeslot+"\n\nYour appointment is to start fermentation in store — it takes about 15 minutes. We'll contact you when it's time to come back and bottle.\n\nIf you need to reschedule, please reply to this email or give us a call.\n\nSee you soon!\nSteins & Vines")}var J="name",Q="asc",Z={SKU:"sku",Brand:"brand",Name:"name",Type:"type",Tint:"tint",Stock:"stock","On Hold":"on_hold","On Order":"on_order",Available:"_available","In-Store":"retail_instore",Kit:"retail_kit"};function X(){var e=document.getElementById("kits-tbody"),t=document.getElementById("kits-empty");if(e){var n=document.getElementById("kit-brand-filter").value,a=document.getElementById("kit-stock-filter").value,i=document.getElementById("kit-search"),d=i?i.value.toLowerCase():"",s=o.filter(function(e){if("all"!==n&&e.brand!==n)return!1;var t=parseInt(e.available,10);if(isNaN(t)&&(t=parseInt(e.stock,10)||0),"in"===a&&t<=0)return!1;if("low"===a&&(t<=0||t>5))return!1;if("out"===a&&t>0)return!1;if(d&&-1===((e.name||"")+" "+(e.brand||"")+" "+(e.sku||"")+" "+(e.type||"")+" "+(e.subcategory||"")).toLowerCase().indexOf(d))return!1;return!0});if(s.sort(function(e,t){var n,a;"_available"===J?(n=(parseInt(e.stock,10)||0)-(parseInt(e.on_hold,10)||0),a=(parseInt(t.stock,10)||0)-(parseInt(t.on_hold,10)||0)):(n=e[J]||"",a=t[J]||"");var o,r=parseFloat(String(n).replace(/[^0-9.\-]/g,"")),i=parseFloat(String(a).replace(/[^0-9.\-]/g,""));return o=isNaN(r)||isNaN(i)?String(n).localeCompare(String(a)):r-i,"asc"===Q?o:-o}),document.querySelectorAll("#kits-table thead th.sortable").forEach(function(e){e.classList.remove("sort-asc","sort-desc"),e.getAttribute("data-sort-key")===J&&e.classList.add("asc"===Q?"sort-asc":"sort-desc")}),e.innerHTML="",0===s.length)return t.style.display="",void(document.getElementById("kits-table").style.display="none");t.style.display="none",document.getElementById("kits-table").style.display="",s.forEach(function(t){var n=document.createElement("tr");j(n,t.sku||""),j(n,t.brand||""),j(n,t.name||""),j(n,t.type||""),j(n,t.tint||"");var a,o,i=document.createElement("td");i.className="admin-editable",i.textContent=t.stock||"0",i.addEventListener("click",(a=i,o=t,function(){te(a,o,"stock")})),n.appendChild(i);var d=document.createElement("td");d.className="admin-editable",d.textContent=t.on_hold||"0",d.addEventListener("click",function(e,t){return function(){te(e,t,"on_hold")}}(d,t)),n.appendChild(d);var s=document.createElement("td");s.className="admin-editable",s.textContent=t.on_order||"0",s.addEventListener("click",function(e,t){return function(){te(e,t,"on_order")}}(s,t)),n.appendChild(s);var l=(parseInt(t.stock,10)||0)-(parseInt(t.on_hold,10)||0),c=document.createElement("td");c.setAttribute("data-avail-sku",t.sku||t.name);var u=document.createElement("span");ee(u,l),c.appendChild(u),n.appendChild(c),j(n,t.retail_instore?"$"+String(t.retail_instore).replace("$",""):""),j(n,t.retail_kit?"$"+String(t.retail_kit).replace("$",""):"");var m=document.createElement("td"),f=document.createElement("button");f.type="button",f.className="btn-secondary admin-btn-sm",f.textContent="Hold",f.addEventListener("click",function(e){return function(){!function(e){var t='<form id="manual-hold-form" class="admin-modal-form">';t+='<div class="form-group"><label>Product</label><input type="text" value="'+Ze((e.brand||"")+" "+(e.name||""))+'" disabled></div>',t+='<div class="form-group"><label for="hold-qty">Quantity</label><input type="number" id="hold-qty" value="1" min="1" required></div>',t+='<div class="form-group"><label for="hold-notes">Notes</label><input type="text" id="hold-notes" placeholder="e.g. Phone order for John"></div>',t+='<button type="submit" class="btn">Place Hold</button>',t+="</form>",R("Hold — "+(e.name||""),t),document.getElementById("manual-hold-form").addEventListener("submit",function(t){t.preventDefault();var n=parseInt(document.getElementById("hold-qty").value,10)||1,a=Xe(document.getElementById("hold-notes").value.trim()),o=new Date,i=["H-"+o.toISOString().slice(0,10).replace(/-/g,"")+"-M"+String(Math.floor(900*Math.random())+100),"",e.sku||"",(e.brand||"")+" "+(e.name||""),n,"pending",o.toISOString(),"","",a];H(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!A:A",[i]).then(function(){var t=r.indexOf("on_hold");if(-1!==t){var a=(parseInt(e.on_hold,10)||0)+n;return O(SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+Qe(t)+e._rowIndex,[[a]]).then(function(){e.on_hold=String(a)})}}).then(function(){G(),B()}).catch(function(e){y("Failed to place hold: "+e.message,"error")})})}(e)}}(t)),m.appendChild(f);var p=document.createElement("button");p.type="button",p.className="btn-secondary admin-btn-sm",p.textContent="+Order",p.addEventListener("click",function(e){return function(){he(e.sku||"",e.brand||"",e.name||"",1)}}(t)),m.appendChild(p),n.appendChild(m),e.appendChild(n)})}}function ee(e,t){e.className=t<=0?"stock-badge stock-badge--out":t<=5?"stock-badge stock-badge--low":"stock-badge stock-badge--in",e.textContent=t}function te(e,t,n){if(!e.querySelector("input")){var a=t[n]||"0",o=document.createElement("input");o.type="number",o.className="admin-inline-input",o.value=a,o.min="0",e.textContent="",e.appendChild(o),o.focus(),o.select(),o.addEventListener("blur",function(){var r=o.value.trim();(""===r||isNaN(r))&&(r=a),e.textContent=r,r!==a&&(t[n]=r,e.classList.add("admin-cell-changed"),function(e,t,n){for(var a=0;a<v.length;a++)if(v[a].item===e&&v[a].field===t)return v[a].value=n,void ne();v.push({item:e,field:t,value:n}),ne()}(t,n,r),"stock"!==n&&"on_hold"!==n||function(e){var t=e.sku||e.name,n=document.querySelector('[data-avail-sku="'+t+'"]');if(n){var a=(parseInt(e.stock,10)||0)-(parseInt(e.on_hold,10)||0),o=n.querySelector(".stock-badge");o&&ee(o,a)}}(t))}),o.addEventListener("keydown",function(t){"Enter"===t.key&&(t.preventDefault(),o.blur()),"Escape"===t.key&&(e.textContent=a)})}}function ne(){var e=document.getElementById("admin-save-bar");if(e)if(v.length>0){e.style.display="";var t=v.length;document.getElementById("admin-save-count").textContent=t+" unsaved change"+(1===t?"":"s")}else e.style.display="none"}function ae(){if(0!==v.length){var e=document.getElementById("admin-save-btn");e&&(e.disabled=!0,e.textContent="Saving...");var t=[];v.forEach(function(e){var n,a;-1!==o.indexOf(e.item)?(n=r,a=SHEETS_CONFIG.SHEET_NAMES.KITS):(n=d,a=SHEETS_CONFIG.SHEET_NAMES.INGREDIENTS);var i=n.indexOf(e.field);if(-1!==i){var s=a+"!"+Qe(i)+e.item._rowIndex;t.push(O(s,[[e.value]]));var l=n.indexOf("last_updated");if(-1!==l){var c=a+"!"+Qe(l)+e.item._rowIndex;t.push(O(c,[[(new Date).toISOString()]])),e.item.last_updated=(new Date).toISOString()}}}),Promise.all(t).then(function(){v=[],ne(),document.querySelectorAll(".admin-cell-changed").forEach(function(e){e.classList.remove("admin-cell-changed")}),e&&(e.disabled=!1,e.textContent="Save All Changes")}).catch(function(t){y("Failed to save changes: "+t.message,"error"),e&&(e.disabled=!1,e.textContent="Save All Changes")})}}function oe(){v=[],ne(),B()}function re(){var e=document.getElementById("ingredients-tbody"),t=document.getElementById("ingredients-empty");if(e){var n=document.getElementById("ing-type-filter").value,a=i;if("all"!==n&&(a=i.filter(function(e){return e.type===n})),e.innerHTML="",0===a.length)return t.style.display="",void(document.getElementById("ingredients-table").style.display="none");t.style.display="none",document.getElementById("ingredients-table").style.display="",a.forEach(function(t){var n=document.createElement("tr");j(n,t.sku||""),j(n,t.type||""),j(n,t.name||""),j(n,t.supplier||"");var a=(t.cost||"").replace(/\$/g,"").trim();j(n,a?"$"+a:"");var o,r=document.createElement("td"),s=document.createElement("button");s.type="button",s.className="btn-secondary admin-btn-sm admin-btn-danger",s.textContent="Delete",s.addEventListener("click",(o=t,function(){!function(e){if(confirm('Delete ingredient "'+e.name+'"? This cannot be undone.')){var t=SHEETS_CONFIG.SHEET_NAMES.INGREDIENTS+"!A"+e._rowIndex+":"+Qe(d.length-1)+e._rowIndex,n=d.map(function(){return""});O(t,[n]).then(function(){var t=i.indexOf(e);-1!==t&&i.splice(t,1),re()}).catch(function(e){y("Failed to delete: "+e.message,"error")})}}(o)})),r.appendChild(s),n.appendChild(r),e.appendChild(n)})}}document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("add-kit-btn");e&&e.addEventListener("click",function(){var e;e='<form id="add-kit-form" class="admin-modal-form">',[{key:"type",label:"Type",type:"text",value:"Wine"},{key:"brand",label:"Brand",type:"text"},{key:"name",label:"Name",type:"text"},{key:"subcategory",label:"Subcategory",type:"text"},{key:"sku",label:"SKU",type:"text"},{key:"retail_instore",label:"Retail In-Store",type:"text",placeholder:"$0.00"},{key:"retail_kit",label:"Retail Kit",type:"text",placeholder:"$0.00"},{key:"time",label:"Time",type:"text",placeholder:"8 weeks"},{key:"wholesale",label:"Wholesale",type:"text",placeholder:"$0.00"},{key:"tasting_notes",label:"Tasting Notes",type:"text"},{key:"abv",label:"ABV",type:"text",placeholder:"13%"},{key:"tint",label:"Tint Color",type:"select",options:["","red","white","rose","fruit","specialty","pilsner","amber","wheat","ipa","pale","session","saison","lager","stout","porter","redale","brown"]},{key:"stock",label:"Stock",type:"number",value:"0"},{key:"on_order",label:"On Order",type:"number",value:"0"},{key:"favorite",label:"Favorite",type:"select",options:["FALSE","TRUE"]}].forEach(function(t){e+='<div class="form-group">',e+='<label for="kit-'+t.key+'">'+t.label+"</label>","select"===t.type?(e+='<select id="kit-'+t.key+'" class="admin-select">',t.options.forEach(function(t){e+='<option value="'+t+'">'+t+"</option>"}),e+="</select>"):e+='<input type="'+t.type+'" id="kit-'+t.key+'"'+(t.value?' value="'+t.value+'"':"")+(t.placeholder?' placeholder="'+t.placeholder+'"':"")+">",e+="</div>"}),e+='<button type="submit" class="btn">Add Kit</button>',R("Add Kit",e+="</form>"),document.getElementById("add-kit-form").addEventListener("submit",function(e){e.preventDefault();var t=r.map(function(e){var t=document.getElementById("kit-"+e);return t?"text"===t.type||"TEXTAREA"===t.tagName?Xe(t.value):t.value:"on_hold"===e?"0":"available"===e?"":"last_updated"===e?(new Date).toISOString():""});H(SHEETS_CONFIG.SHEET_NAMES.KITS+"!A:A",[t]).then(function(){G(),B()}).catch(function(e){y("Failed to add kit: "+e.message,"error")})})})}),document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("add-ingredient-btn");e&&e.addEventListener("click",function(){var e,t,n,a;e=["Hops","Yeast","Additives","Finings","Sugar","Other"],t=["g","kg","packet","ml","L"],n="ING-"+String(i.length+1).padStart(3,"0"),a='<form id="add-ing-form" class="admin-modal-form">',a+='<div class="form-group"><label for="ing-sku">SKU</label><input type="text" id="ing-sku" value="'+n+'"></div>',a+='<div class="form-group"><label for="ing-type">Category</label><select id="ing-type" class="admin-select">',e.forEach(function(e){a+='<option value="'+e+'">'+e+"</option>"}),a+="</select></div>",a+='<div class="form-group"><label for="ing-name">Name</label><input type="text" id="ing-name" required></div>',a+='<div class="form-group"><label for="ing-unit">Unit</label><select id="ing-unit" class="admin-select">',t.forEach(function(e){a+='<option value="'+e+'">'+e+"</option>"}),a+="</select></div>",a+='<div class="form-group"><label for="ing-stock_qty">Stock Qty</label><input type="number" id="ing-stock_qty" value="0" min="0"></div>',a+='<div class="form-group"><label for="ing-reorder_level">Reorder Level</label><input type="number" id="ing-reorder_level" value="0" min="0"></div>',a+='<div class="form-group"><label for="ing-supplier">Supplier</label><input type="text" id="ing-supplier"></div>',a+='<div class="form-group"><label for="ing-cost">Cost</label><input type="text" id="ing-cost" placeholder="$0.00"></div>',a+='<div class="form-group"><label for="ing-notes">Notes</label><input type="text" id="ing-notes"></div>',a+='<button type="submit" class="btn">Add Ingredient</button>',R("Add Ingredient",a+="</form>"),document.getElementById("add-ing-form").addEventListener("submit",function(e){e.preventDefault();var t=d.map(function(e){var t=document.getElementById("ing-"+e);return t?"text"===t.type||"TEXTAREA"===t.tagName?Xe(t.value):t.value:"last_updated"===e?(new Date).toISOString():""});H(SHEETS_CONFIG.SHEET_NAMES.INGREDIENTS+"!A:A",[t]).then(function(){G(),B()}).catch(function(e){y("Failed to add ingredient: "+e.message,"error")})})})});var ie="brand",de="asc",se={SKU:"sku",Brand:"brand",Name:"name",Qty:"qty",Cost:"_cost","Line Total":"_total"};function le(){var e=document.getElementById("order-brand-filter");if(e){var t=ue(),n=[];for(t.forEach(function(e){e.brand&&-1===n.indexOf(e.brand)&&n.push(e.brand)}),n.sort();e.options.length>1;)e.remove(1);n.forEach(function(t){var n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)})}}var ce="sv-admin-order";function ue(){try{return JSON.parse(localStorage.getItem(ce))||[]}catch(e){return[]}}function me(e){localStorage.setItem(ce,JSON.stringify(e))}var fe=["Heritage Estates","Orchard Breezin'"];function pe(e){return-1!==fe.indexOf(e)}function ve(t){if(e&&0!==o.length){var n=r.indexOf("on_order");if(-1!==n){var a=ue(),i=[];t.forEach(function(e){var t=o.find(function(t){return t.sku===e});if(t){var r=a.find(function(t){return t.sku===e}),d=r?r.qty:0,s=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+Qe(n)+t._rowIndex;i.push(O(s,[[d]])),t.on_order=String(d)}}),i.length>0&&Promise.all(i).then(function(){X()}).catch(function(e){console.error("Failed to sync on_order:",e)})}}}function he(e,t,n,a){var o=pe(t)?2:1;2===o&&a%2!=0&&(a=2*Math.ceil(a/2));for(var r=ue(),i=0;i<r.length;i++)if(r[i].sku===e)return r[i].qty+=a,2===o&&r[i].qty%2!=0&&(r[i].qty=2*Math.ceil(r[i].qty/2)),me(r),ve([e]),void ge();r.push({sku:e,brand:t,name:n,qty:a}),me(r),ve([e]),le(),ge()}function Ee(e,t){for(var n=ue(),a=0;a<n.length;a++)if(n[a].sku===e){var o=pe(n[a].brand)?2:1;t<=0?n.splice(a,1):(2===o&&t%2!=0&&(t=2*Math.ceil(t/2)),n[a].qty=t);break}me(n),ve([e]),le(),ge()}function ge(){var e=document.getElementById("order-tbody"),t=document.getElementById("order-empty"),n=document.getElementById("order-table");if(e){var a=ue();e.innerHTML="";var r=document.getElementById("order-search"),i=r?r.value.toLowerCase():"",d=document.getElementById("order-brand-filter"),s=d?d.value:"all",l=a.filter(function(e){if("all"!==s&&e.brand!==s)return!1;if(i&&-1===((e.name||"")+" "+(e.brand||"")+" "+(e.sku||"")).toLowerCase().indexOf(i))return!1;return!0});if(l.sort(function(e,t){var n,a;if("_cost"===ie||"_total"===ie){var r=o.find(function(t){return t.sku===e.sku}),i=o.find(function(e){return e.sku===t.sku}),d=r&&r.wholesale&&parseFloat(String(r.wholesale).replace(/[^0-9.\-]/g,""))||0,s=i&&i.wholesale&&parseFloat(String(i.wholesale).replace(/[^0-9.\-]/g,""))||0;"_total"===ie?(n=d*e.qty,a=s*t.qty):(n=d,a=s)}else"qty"===ie?(n=e.qty||0,a=t.qty||0):(n=e[ie]||"",a=t[ie]||"");var l,c=parseFloat(String(n).replace(/[^0-9.\-]/g,"")),u=parseFloat(String(a).replace(/[^0-9.\-]/g,""));return l=isNaN(c)||isNaN(u)?String(n).localeCompare(String(a)):c-u,"asc"===de?l:-l}),document.querySelectorAll("#order-table thead th.sortable").forEach(function(e){e.classList.remove("sort-asc","sort-desc"),e.getAttribute("data-sort-key")===ie&&e.classList.add("asc"===de?"sort-asc":"sort-desc")}),0===l.length)return t&&(t.style.display=""),void(n&&(n.style.display="none"));t&&(t.style.display="none"),n&&(n.style.display="");var c=document.getElementById("order-select-all");c&&(c.checked=!0,c.onchange=function(){for(var t=e.querySelectorAll(".order-item-cb"),n=0;n<t.length;n++)t[n].checked=c.checked});var u=0;l.forEach(function(t){var n=document.createElement("tr"),a=document.createElement("td"),r=document.createElement("input");r.type="checkbox",r.checked=!0,r.className="order-item-cb",r.setAttribute("data-sku",t.sku),r.addEventListener("change",function(){!r.checked&&c&&(c.checked=!1)}),a.appendChild(r),n.appendChild(a),j(n,t.sku||""),j(n,t.brand||"");var i=document.createElement("td");if(i.textContent=t.name||"",pe(t.brand)){var d=document.createElement("span");d.textContent=" (2-pack)",d.style.color="#888",d.style.fontSize="0.85em",i.appendChild(d)}n.appendChild(i);var s=document.createElement("td"),l=document.createElement("div");l.className="product-qty-controls";var m,f,p,v=pe(t.brand)?2:1,h=document.createElement("button");h.type="button",h.className="qty-btn",h.textContent="−",h.addEventListener("click",(m=t.sku,f=t.qty,p=v,function(){Ee(m,f-p)}));var E=document.createElement("span");E.className="qty-value",E.textContent=t.qty;var g=document.createElement("button");g.type="button",g.className="qty-btn",g.textContent="+",g.addEventListener("click",function(e,t,n){return function(){Ee(e,t+n)}}(t.sku,t.qty,v)),l.appendChild(h),l.appendChild(E),l.appendChild(g),s.appendChild(l),n.appendChild(s);var y=o.find(function(e){return e.sku===t.sku}),b=0;y&&y.wholesale&&(String(y.wholesale),b=parseFloat(String(y.wholesale).replace(/[^0-9.\-]/g,""))||0);var S=b*t.qty;u+=S,j(n,b?"$"+b.toFixed(2):""),j(n,b?"$"+S.toFixed(2):"");var I=document.createElement("td"),k=document.createElement("button");k.type="button",k.className="btn-secondary admin-btn-sm admin-btn-danger",k.textContent="Remove",k.addEventListener("click",function(e){return function(){var t;t=e,me(ue().filter(function(e){return e.sku!==t})),ve([t]),le(),ge()}}(t.sku)),I.appendChild(k),n.appendChild(I),e.appendChild(n)});var m=document.createElement("tr");m.style.fontWeight="700";var f=document.createElement("td");f.colSpan=6,f.style.textAlign="right",f.textContent="Order Total:",m.appendChild(f);var p=document.createElement("td");p.textContent="$"+u.toFixed(2),m.appendChild(p);var v=document.createElement("td");m.appendChild(v),e.appendChild(m)}}var ye=[];function be(){var e=ue();if(0!==e.length){var t=e.map(function(e){return e.qty+"x  "+e.brand+" — "+e.name+"  (SKU: "+e.sku+")"}),n="Supplier Order — "+(new Date).toLocaleDateString()+"\n—————————————————————\n"+t.join("\n")+"\n—————————————————————\nTotal items: "+e.reduce(function(e,t){return e+t.qty},0);navigator.clipboard.writeText(n).then(function(){var e=document.getElementById("order-copy-btn");e.textContent="Copied!",setTimeout(function(){e.textContent="Copy Order List"},2e3)}).catch(function(){prompt("Copy this order:",n)})}else y("Order is empty.","warning")}function Se(){var e=ue();if(0!==e.length){for(var t={},n=document.querySelectorAll(".order-item-cb:checked"),a=0;a<n.length;a++)t[n[a].getAttribute("data-sku")]=!0;var i=e.filter(function(e){return t[e.sku]}),d=e.filter(function(e){return!t[e.sku]});if(0!==i.length){var s="Accept delivery for "+i.length+" of "+e.length+" item(s)? This will add ordered quantities to stock and subtract from on_order for the selected kits.";if(confirm(s)){var l=document.getElementById("order-accept-btn");l&&(l.disabled=!0,l.textContent="Processing...");var c=[];i.forEach(function(e){var t=o.find(function(t){return t.sku===e.sku});if(t){var n=r.indexOf("stock");if(-1!==n){var a=(parseInt(t.stock,10)||0)+e.qty,i=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+Qe(n)+t._rowIndex;c.push(O(i,[[a]])),t.stock=String(a)}var d=r.indexOf("on_order");if(-1!==d){var s=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+Qe(d)+t._rowIndex;c.push(O(s,[[0]])),t.on_order="0"}var l=r.indexOf("last_updated");if(-1!==l){var u=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+Qe(l)+t._rowIndex;c.push(O(u,[[(new Date).toISOString()]]))}}}),Promise.all(c).then(function(){me(d),ge(),X(),l&&(l.disabled=!1,l.textContent="Accept Delivery"),y("Delivery accepted. Stock updated for "+i.length+" item(s)."+(d.length>0?" "+d.length+" item(s) remain in the order.":""),"success")}).catch(function(e){l&&(l.disabled=!1,l.textContent="Accept Delivery"),y("Failed to update stock: "+e.message,"error")})}}else y("No items selected.","warning")}else y("Order is empty.","warning")}function Ie(){if(confirm("Clear the entire order? This cannot be undone.")){var e=ue().map(function(e){return e.sku});me([]),ve(e),ge()}}var ke=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function Ce(){var e=localStorage.getItem("sv_schedule_defaults");if(e)try{var t=JSON.parse(e);return t.forEach(function(e){e.blockedSlots||(e.blockedSlots=[])}),t}catch(e){}return[{day:"Sun",start:"",end:"",open:!1,blockedSlots:[]},{day:"Mon",start:"",end:"",open:!1,blockedSlots:[]},{day:"Tue",start:"10:00 AM",end:"4:00 PM",open:!0,blockedSlots:[]},{day:"Wed",start:"10:00 AM",end:"4:00 PM",open:!0,blockedSlots:[]},{day:"Thu",start:"12:00 PM",end:"7:00 PM",open:!0,blockedSlots:[]},{day:"Fri",start:"10:00 AM",end:"4:00 PM",open:!0,blockedSlots:[]},{day:"Sat",start:"10:00 AM",end:"4:00 PM",open:!0,blockedSlots:[]}]}function _e(e){localStorage.setItem("sv_schedule_defaults",JSON.stringify(e))}function we(){var e=document.getElementById("schedule-defaults-tbody");if(e){e.innerHTML="";var t=Ce(),n=function(){for(var e=[""],t=6;t<=21;t++)for(var n=0;n<60;n+=30){var a=t>12?t-12:0===t?12:t,o=t>=12?"PM":"AM",r=n<10?"0"+n:""+n;e.push(a+":"+r+" "+o)}return e}();t.forEach(function(t,a){var o=document.createElement("tr"),r=document.createElement("td");r.textContent=t.day,o.appendChild(r);var i=document.createElement("td"),d=document.createElement("select");d.className="admin-select",d.dataset.idx=a,d.dataset.field="start",n.forEach(function(e){var n=document.createElement("option");n.value=e,n.textContent=e||"—",e===t.start&&(n.selected=!0),d.appendChild(n)}),i.appendChild(d),o.appendChild(i);var s=document.createElement("td"),l=document.createElement("select");l.className="admin-select",l.dataset.idx=a,l.dataset.field="end",n.forEach(function(e){var n=document.createElement("option");n.value=e,n.textContent=e||"—",e===t.end&&(n.selected=!0),l.appendChild(n)}),s.appendChild(l),o.appendChild(s);var c=document.createElement("td"),u=document.createElement("button");if(u.type="button",u.className="btn-secondary admin-btn-sm"+(t.open?" schedule-open":" schedule-closed"),u.textContent=t.open?"Open":"Closed",u.dataset.idx=a,u.addEventListener("click",function(){var e=parseInt(this.dataset.idx,10),t=Ce();t[e].open=!t[e].open,t[e].open||(t[e].start="",t[e].end=""),_e(t),we()}),c.appendChild(u),o.appendChild(c),e.appendChild(o),t.open&&t.start&&t.end){var m=document.createElement("tr"),f=document.createElement("td");f.colSpan=4,f.className="schedule-default-slots";var p=t.blockedSlots||[];xe(t.start,t.end).forEach(function(e){var t=document.createElement("button");t.type="button";var n=-1!==p.indexOf(e);t.className="schedule-default-slot"+(n?" blocked":""),t.textContent=e,t.addEventListener("click",function(){var t=Ce();t[a].blockedSlots||(t[a].blockedSlots=[]);var n=t[a].blockedSlots.indexOf(e);-1!==n?t[a].blockedSlots.splice(n,1):t[a].blockedSlots.push(e),_e(t),we()}),f.appendChild(t)}),m.appendChild(f),e.appendChild(m)}})}}function xe(e,t){var n=[];if(!e||!t)return n;for(var a=Ne(e),o=Ne(t),r=a;r<o;r+=30)n.push(Te(r));return n}function Ne(e){var t=e.match(/(\d+):(\d+)\s*(AM|PM)/i);if(!t)return 0;var n=parseInt(t[1],10),a=parseInt(t[2],10),o=t[3].toUpperCase();return"PM"===o&&12!==n&&(n+=12),"AM"===o&&12===n&&(n=0),60*n+a}function Te(e){var t=Math.floor(e/60),n=e%60;return(t>12?t-12:0===t?12:t)+":"+(n<10?"0"+n:""+n)+" "+(t>=12?"PM":"AM")}function Ae(e){var t=e.getFullYear(),n=e.getMonth()+1,a=e.getDate();return t+"-"+(n<10?"0"+n:n)+"-"+(a<10?"0"+a:a)}var Le=null,Oe=null;function He(){var e=document.getElementById("schedule-cal");if(e){var t=Le.getFullYear(),n=Le.getMonth(),a=Le.toLocaleString("default",{month:"long",year:"numeric"}),o={};m.forEach(function(e){o[e.date]||(o[e.date]=[]),o[e.date].push(e)});var r='<div class="schedule-cal-header">';r+='<button type="button" class="btn-secondary admin-btn-sm schedule-cal-prev">&laquo;</button>',r+='<span class="schedule-cal-title">'+Ze(a)+"</span>",r+='<button type="button" class="btn-secondary admin-btn-sm schedule-cal-next">&raquo;</button>',r+="</div>",r+='<div class="schedule-cal-actions">',r+='<button type="button" class="btn admin-btn-sm" id="schedule-generate-month-btn">Generate Slots</button>',r+='<button type="button" class="btn-secondary admin-btn-sm" id="schedule-reset-month-btn">Reset to Defaults</button>',r+="</div>",r+='<div class="schedule-cal-grid">',ke.forEach(function(e){r+='<div class="schedule-cal-dayheader">'+e+"</div>"});for(var i=new Date(t,n,1).getDay(),d=0;d<i;d++)r+='<div class="schedule-cal-cell empty"></div>';for(var s=Ce(),l=new Date(t,n+1,0).getDate(),c=1;c<=l;c++){var u=new Date(t,n,c),p=Ae(u),v=!s[u.getDay()].open,h=o[p]||[],E=h.filter(function(e){return"available"===e.status}).length,g=h.filter(function(e){return"booked"===e.status}).length,b=h.filter(function(e){return"blocked"===e.status}).length,S="";0===h.length?S="":E>0?S="dot-available":g>0&&0===E?S="dot-booked":b>0&&0===E&&0===g&&(S="dot-blocked"),r+='<div class="schedule-cal-cell'+(p===Oe?" selected":"")+(v?" closed":"")+'" data-date="'+p+'">',r+='<span class="schedule-cal-day">'+c+"</span>",v?r+='<span class="schedule-cal-closed">Closed</span>':S&&(r+='<span class="schedule-cal-dot '+S+'"></span>'),h.length>0&&!v&&(r+='<span class="schedule-cal-counts">',r+='<span class="cal-count-open">'+E+"</span>",r+='<span class="cal-count-booked">'+g+"</span>",r+="</span>"),r+="</div>"}r+="</div>",e.innerHTML=r,e.querySelector(".schedule-cal-prev").addEventListener("click",function(){Le.setMonth(Le.getMonth()-1),He()}),e.querySelector(".schedule-cal-next").addEventListener("click",function(){Le.setMonth(Le.getMonth()+1),He()}),e.querySelectorAll(".schedule-cal-cell[data-date]").forEach(function(e){e.addEventListener("click",function(){Oe=this.dataset.date,He(),Be(Oe)})});var I=e.querySelector("#schedule-generate-month-btn");I&&I.addEventListener("click",function(){!function(){if(Le){var e=Ce(),t=Le.getFullYear(),n=Le.getMonth(),a=new Date(t,n+1,0).getDate(),o=Le.toLocaleString("default",{month:"long",year:"numeric"}),r=new Date;r.setHours(0,0,0,0);var i={};m.forEach(function(e){i[e.date+"|"+e.time]=!0});for(var d=[],s=1;s<=a;s++){var l=new Date(t,n,s);if(!(l<r)){var c=e[l.getDay()];if(c.open&&c.start&&c.end){var u=Ae(l),f=c.blockedSlots||[];xe(c.start,c.end).forEach(function(e){-1===f.indexOf(e)&&(i[u+"|"+e]||d.push([u,e,"available"]))})}}}0!==d.length?confirm("Generate "+d.length+" new slot(s) for "+o+"?")&&H(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!A:C",d).then(function(){y(d.length+" slots generated for "+o+".","success"),B()}).catch(function(e){y("Failed to generate slots: "+e.message,"error")}):y("No new slots to generate for "+o+" (all slots already exist).","warning")}}()});var k=e.querySelector("#schedule-reset-month-btn");k&&k.addEventListener("click",function(){!function(){if(!Le)return;var e=Ce(),t=Le.getFullYear(),n=Le.getMonth(),a=new Date(t,n+1,0).getDate(),o=f.indexOf("status");if(-1===o)return void y("Cannot find status column.","warning");var r=new Date;r.setHours(0,0,0,0);for(var i={},d=1;d<=a;d++){var s=new Date(t,n,d);if(!(s<r)){var l=Ae(s),c=e[s.getDay()];if(c.open&&c.start&&c.end){var u=c.blockedSlots||[];xe(c.start,c.end).forEach(function(e){-1===u.indexOf(e)&&(i[l+"|"+e]=!0)})}}}var p=function(){var e=Le.getFullYear(),t=Le.getMonth()+1;return e+"-"+(t<10?"0"+t:t)}(),v=m.filter(function(e){return e.date&&e.date.substring(0,7)===p}),h=[];if(v.forEach(function(e){if("booked"!==e.status){var t=e.date+"|"+e.time,n=!!i[t];n&&"available"!==e.status?h.push({slot:e,newStatus:"available"}):n||"blocked"===e.status||h.push({slot:e,newStatus:"blocked"})}}),0===h.length)return void y("All slots already match defaults.","warning");if(!confirm("This will update "+h.length+" slot(s) in "+Le.toLocaleString("default",{month:"long",year:"numeric"})+" to match your default schedule. Booked slots will not be changed. Continue?"))return;var E=h.map(function(e){return O(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!"+Qe(o)+e.slot._rowIndex,[[e.newStatus]]).then(function(){e.slot.status=e.newStatus})});Promise.all(E).then(function(){y(h.length+" slot(s) updated to match defaults.","success"),He()}).catch(function(e){y("Failed to reset slots: "+e.message,"error"),B()})}()}),Oe&&Be(Oe)}}function Be(e){var t=document.getElementById("schedule-day-slots");if(t){var n=m.filter(function(t){return t.date===e});if(n.sort(function(e,t){return Ne(e.time)-Ne(t.time)}),0!==n.length){var a='<div class="schedule-day-header">';a+="<h4>"+Ze(e)+"</h4>",a+='<button type="button" class="btn-secondary admin-btn-sm" id="schedule-block-day">Block Entire Day</button>',a+='<button type="button" class="btn-secondary admin-btn-sm" id="schedule-open-day">Open Entire Day</button>',a+='<button type="button" class="btn-secondary admin-btn-sm" id="schedule-reset-day">Reset to Default</button>',a+="</div>",a+='<div class="schedule-slots">',n.forEach(function(e){var t="schedule-slot slot-"+e.status,n="booked"===e.status?" disabled":"";a+='<button type="button" class="'+t+'" data-date="'+Ze(e.date)+'" data-time="'+Ze(e.time)+'" data-row="'+e._rowIndex+'"'+n+">",a+=Ze(e.time),"booked"===e.status&&(a+=" <small>(booked)</small>"),a+="</button>"}),a+="</div>",t.innerHTML=a,t.querySelectorAll(".schedule-slot:not([disabled])").forEach(function(e){e.addEventListener("click",function(){!function(e,t,n){var a=m.find(function(n){return n.date===e&&n.time===t});if(!a||"booked"===a.status)return;var o="available"===a.status?"blocked":"available",r=f.indexOf("status");if(-1===r)return;O(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!"+Qe(r)+n,[[o]]).then(function(){a.status=o,He()}).catch(function(e){y("Failed to update slot: "+e.message,"error")})}(this.dataset.date,this.dataset.time,parseInt(this.dataset.row,10))})});var o=document.getElementById("schedule-block-day");o&&o.addEventListener("click",function(){Me(e,"blocked")});var r=document.getElementById("schedule-open-day");r&&r.addEventListener("click",function(){Me(e,"available")});var i=document.getElementById("schedule-reset-day");i&&i.addEventListener("click",function(){!function(e){var t=Ce(),n=new Date(e+"T00:00:00"),a=n.getDay(),o=t[a],r=f.indexOf("status");if(-1===r)return;var i={};if(o.open&&o.start&&o.end){var d=o.blockedSlots||[];xe(o.start,o.end).forEach(function(e){-1===d.indexOf(e)&&(i[e]=!0)})}var s=m.filter(function(t){return t.date===e}),l=[];if(s.forEach(function(e){if("booked"!==e.status){var t=!!i[e.time];t&&"available"!==e.status?l.push({slot:e,newStatus:"available"}):t||"blocked"===e.status||l.push({slot:e,newStatus:"blocked"})}}),0===l.length)return void y("Day already matches defaults.","warning");var c=l.map(function(e){return O(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!"+Qe(r)+e.slot._rowIndex,[[e.newStatus]]).then(function(){e.slot.status=e.newStatus})});Promise.all(c).then(function(){He()}).catch(function(e){y("Failed to reset day: "+e.message,"error")})}(e)})}else t.innerHTML='<p class="admin-empty">No slots for '+Ze(e)+"</p>"}}function Me(e,t){var n=m.filter(function(t){return t.date===e&&"booked"!==t.status});if(0!==n.length){var a=f.indexOf("status");if(-1!==a){var o=n.map(function(e){return O(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!"+Qe(a)+e._rowIndex,[[t]]).then(function(){e.status=t})});Promise.all(o).then(function(){He()}).catch(function(e){y("Failed to update day: "+e.message,"error")})}}}function De(){var e=[["Product Name","SKU","Category","Subcategory","Price","Kit Price","Cost","Stock On Hand","On Order","Notes"]];o.forEach(function(t){e.push([((t.brand||"")+" "+(t.name||"")).trim(),t.sku||"",t.type||"",t.subcategory||"",(t.retail_instore||"").replace("$",""),(t.retail_kit||"").replace("$",""),(t.wholesale||"").replace("$",""),t.stock||"0",t.on_order||"0",t.tasting_notes||""])});var t=(new Date).toISOString().split("T")[0];Pe(e,"sv-kits-export-"+t+".csv")}function Fe(){var e=[d.slice()];i.forEach(function(t){var n=d.map(function(e){return t[e]||""});e.push(n)});var t=(new Date).toISOString().split("T")[0];Pe(e,"sv-ingredients-export-"+t+".csv")}function qe(){var e=[["Stock Code/SKU","Name","Retail Price","Wholesale Price","Qty"]];o.forEach(function(t){e.push([t.sku||"",((t.brand||"")+" "+(t.name||"")).trim(),(t.retail_instore||"").replace("$",""),(t.wholesale||"").replace("$",""),t.stock||"0"])}),i.forEach(function(t){e.push([t.sku||"",t.name||"",(t.cost||"").replace("$",""),(t.cost||"").replace("$",""),t.stock_qty||"0"])});var t=(new Date).toISOString().split("T")[0];Pe(e,"sv-winescheduler-export-"+t+".csv")}function Pe(e,t){var n=e.map(function(e){return e.map(function(e){var t=String(e);return-1!==t.indexOf(",")||-1!==t.indexOf('"')||-1!==t.indexOf("\n")?'"'+t.replace(/"/g,'""')+'"':t}).join(",")}).join("\n"),a=new Blob([n],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a");o.href=URL.createObjectURL(a),o.download=t,o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)}var Re=null;function Ge(e){var t=e.target.files[0];if(t){var n=new FileReader;n.onload=function(e){var t=e.target.result.trim().split("\n");if(t.length<2)y("CSV file is empty or has no data rows.","warning");else{for(var n=je(t[0]).map(function(e){return e.trim()}),a=[],r=1;r<t.length;r++){var i=je(t[r]);if(!(i.length<n.length)){for(var d={},s=0;s<n.length;s++)d[n[s]]=i[s].trim();a.push(d)}}Re={headers:n,rows:a},function(){if(!Re)return;var e=document.getElementById("import-preview"),t=document.getElementById("import-preview-head"),n=document.getElementById("import-preview-body"),a="<tr>";a+="<th>Change</th>",Re.headers.forEach(function(e){a+="<th>"+Ze(e)+"</th>"}),a+="</tr>",t.innerHTML=a,n.innerHTML="";var r=-1!==Re.headers.indexOf("sku")?"sku":"SKU";Re.rows.forEach(function(e){var t=e[r]||e.sku||e.SKU||"",a=o.find(function(e){return e.sku===t}),i=document.createElement("tr"),d=document.createElement("td");if(a){var s=!1;Re.headers.forEach(function(t){var n=t.toLowerCase().replace(/ /g,"_");void 0!==a[n]&&a[n]!==(e[t]||"")&&(s=!0)}),d.textContent=s?"MODIFIED":"UNCHANGED",d.className=s?"admin-diff-mod":""}else d.textContent="NEW",d.className="admin-diff-new";i.appendChild(d),Re.headers.forEach(function(t){j(i,e[t]||"")}),n.appendChild(i)}),e.style.display=""}()}},n.readAsText(t)}}function Ue(){if(Re&&0!==Re.rows.length){var e=[r];Re.rows.forEach(function(t){var n=r.map(function(e){if(void 0!==t[e])return t[e];var n={type:"Category",subcategory:"Subcategory",name:"Product Name",retail_instore:"Price",retail_kit:"Kit Price",wholesale:"Cost",stock:"Stock On Hand",tasting_notes:"Notes"};return n[e]&&void 0!==t[n[e]]?t[n[e]]:""});e.push(n)}),O(SHEETS_CONFIG.SHEET_NAMES.KITS+"!A1:"+Qe(r.length-1)+e.length,e).then(function(){y("Import applied successfully.","success"),Ke(),B()}).catch(function(e){y("Import failed: "+e.message,"error")})}}function Ke(){Re=null,document.getElementById("import-preview").style.display="none",document.getElementById("import-csv-input").value=""}function je(e){for(var t=[],n="",a=!1,o=0;o<e.length;o++){var r=e[o];a?'"'===r?o+1<e.length&&'"'===e[o+1]?(n+='"',o++):a=!1:n+=r:'"'===r?a=!0:","===r?(t.push(n),n=""):n+=r}return t.push(n),t}var Ve={"promo-news":[],"instafeed-url":"","promo-featured-skus":[],"social-instagram":"","social-facebook":"",faq:[]},$e=null;function ze(){var e=[],t=document.getElementById("homepage-news-list");t&&t.querySelectorAll(".homepage-news-item").forEach(function(t){var n=t.querySelector(".news-date"),a=t.querySelector(".news-title"),o=t.querySelector(".news-text");n&&a&&o&&e.push({date:n.value||"",title:Xe(a.value||""),text:Xe(o.value||"")})});Ve["promo-news"]=e;var n=document.getElementById("homepage-instafeed-url");n&&(Ve["instafeed-url"]=Xe(n.value||""));var a=document.querySelectorAll(".homepage-featured-item"),o=[];a.forEach(function(e,t){var n=e.querySelector(".featured-desc"),a=Ve["promo-featured-skus"][t];a&&o.push({sku:a.sku,description:Xe(n?n.value:"")})}),Ve["promo-featured-skus"]=o;var r=document.getElementById("homepage-social-instagram");r&&(Ve["social-instagram"]=Xe(r.value||""));var i=document.getElementById("homepage-social-facebook");i&&(Ve["social-facebook"]=Xe(i.value||""));var d=[],s=document.getElementById("homepage-faq-list");s&&s.querySelectorAll(".homepage-faq-item").forEach(function(e){var t=e.querySelector(".faq-question"),n=e.querySelector(".faq-answer");t&&n&&d.push({question:Xe(t.value||""),answer:Xe(n.value||"")})});Ve.faq=d}function We(){var e=document.getElementById("homepage-news-list");e&&(e.innerHTML="",Ve["promo-news"].forEach(function(t,n){var a=document.createElement("div");a.className="homepage-news-item",a.innerHTML='<div class="homepage-news-item-fields"><input type="text" class="news-date" placeholder="Date (e.g., Jan 15, 2026)" value="'+Ze(t.date||"")+'"><input type="text" class="news-title" placeholder="Title" value="'+Ze(t.title||"")+'"><textarea class="news-text" placeholder="News text...">'+Ze(t.text||"")+'</textarea></div><div class="homepage-news-item-actions"><button type="button" class="btn-secondary admin-btn-sm admin-btn-danger news-remove-btn" data-idx="'+n+'">Remove</button></div>',e.appendChild(a)}),e.querySelectorAll(".news-remove-btn").forEach(function(e){e.addEventListener("click",function(){ze();var e=parseInt(this.dataset.idx,10);Ve["promo-news"].splice(e,1),We()})}))}function Ye(){var e=document.getElementById("homepage-faq-list");e&&(e.innerHTML="",Ve.faq.forEach(function(t,n){var a=document.createElement("div");a.className="homepage-faq-item",a.innerHTML='<div class="homepage-faq-item-fields"><input type="text" class="faq-question" placeholder="Question" value="'+Ze(t.question||"")+'"><textarea class="faq-answer" placeholder="Answer...">'+Ze(t.answer||"")+'</textarea></div><div class="homepage-faq-item-actions"><button type="button" class="btn-secondary admin-btn-sm admin-btn-danger faq-remove-btn" data-idx="'+n+'">Remove</button></div>',e.appendChild(a)}),e.querySelectorAll(".faq-remove-btn").forEach(function(e){e.addEventListener("click",function(){ze();var e=parseInt(this.dataset.idx,10);Ve.faq.splice(e,1),Ye()})}))}function Je(){var e=document.getElementById("homepage-featured-list");e&&(e.innerHTML="",Ve["promo-featured-skus"].forEach(function(t,n){var a=o.find(function(e){return e.sku===t.sku}),r=a?((a.brand||"")+" "+(a.name||"")).trim():"Unknown",i=document.createElement("div");i.className="homepage-featured-item",i.innerHTML='<div class="homepage-featured-item-info"><span class="homepage-featured-item-name">'+Ze(r)+'</span><span class="homepage-featured-item-sku">SKU: '+Ze(t.sku)+'</span></div><textarea class="admin-textarea featured-desc" rows="2" placeholder="Description for this product...">'+Ze(t.description||"")+'</textarea><button type="button" class="btn-secondary admin-btn-sm admin-btn-danger featured-remove-btn" data-idx="'+n+'">Remove</button>',e.appendChild(i)}),e.querySelectorAll(".featured-remove-btn").forEach(function(e){e.addEventListener("click",function(){var e=parseInt(this.dataset.idx,10);Ve["promo-featured-skus"].splice(e,1),Je()})}))}function Qe(e){for(var t="";e>=0;)t=String.fromCharCode(65+e%26)+t,e=Math.floor(e/26)-1;return t}function Ze(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}function Xe(e){if(null==e)return"";if("string"!=typeof e)return String(e);var t=e;return t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"")).replace(/<\/?script[^>]*>/gi,"")).replace(/\s*on\w+\s*=\s*["'][^"']*["']/gi,"")).replace(/\s*on\w+\s*=\s*[^\s>]+/gi,"")).replace(/javascript\s*:/gi,"")).replace(/data\s*:\s*text\/html/gi,"")).replace(/<\/?iframe[^>]*>/gi,"")).replace(/<\/?object[^>]*>/gi,"")).replace(/<\/?embed[^>]*>/gi,"")).replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi,"")).replace(/<\/?style[^>]*>/gi,"")}document.addEventListener("DOMContentLoaded",function(){var t=document.getElementById("homepage-add-news");t&&t.addEventListener("click",function(){ze(),Ve["promo-news"].unshift({date:"",title:"",text:""}),We()});var n=document.getElementById("homepage-add-faq");n&&n.addEventListener("click",function(){ze(),Ve.faq.push({question:"",answer:""}),Ye()});var a,r=document.getElementById("homepage-kit-search"),i=document.getElementById("homepage-kit-dropdown");r&&i&&(r.addEventListener("input",function(){var e=this;clearTimeout(a),a=setTimeout(function(){var t=e.value.toLowerCase().trim();if(t.length<2)i.style.display="none";else{var n=o.filter(function(e){return-1!==(e.name||"").toLowerCase().indexOf(t)||-1!==(e.brand||"").toLowerCase().indexOf(t)||-1!==(e.sku||"").toLowerCase().indexOf(t)}).slice(0,10);0!==n.length?(i.innerHTML="",n.forEach(function(e){var t=document.createElement("div");t.className="admin-kit-search-option",t.innerHTML="<strong>"+Ze(e.brand||"")+"</strong> "+Ze(e.name||"")+' <span style="opacity:0.6">('+Ze(e.sku||"")+")</span>",t.addEventListener("click",function(){$e=e,r.value=(e.brand||"")+" "+(e.name||""),i.style.display="none"}),i.appendChild(t)}),i.style.display="block"):i.style.display="none"}},300)}),r.addEventListener("blur",function(){setTimeout(function(){i.style.display="none"},200)}));var d=document.getElementById("homepage-add-product");d&&d.addEventListener("click",function(){$e&&$e.sku?(Ve["promo-featured-skus"].some(function(e){return e.sku===$e.sku})||(Ve["promo-featured-skus"].push({sku:$e.sku,description:""}),Je()),$e=null,r.value=""):y("Please select a product from the search dropdown.","warning")});var s=document.getElementById("homepage-save-btn");s&&s.addEventListener("click",function(){ze(),function(){var t,n=[["Type","Date","Title","Text","SKU"]];Ve["promo-news"].forEach(function(e){n.push(["news",e.date||"",e.title||"",e.text||"",""])}),Ve["instafeed-url"]&&n.push(["instafeed","","",Ve["instafeed-url"],""]),Ve["promo-featured-skus"].forEach(function(e){n.push(["featured","","",e.description||"",e.sku])}),Ve["social-instagram"]&&n.push(["social","","instagram","",Ve["social-instagram"]]),Ve["social-facebook"]&&n.push(["social","","facebook","",Ve["social-facebook"]]),Ve.faq.forEach(function(e){n.push(["faq","",e.question||"",e.answer||"",""])}),t=SHEETS_CONFIG.ADMIN_API_URL?T("check_auth").then(function(e){if(!e.authorized)throw new Error("Not authorized to make changes")}):Promise.resolve();var a="https://sheets.googleapis.com/v4/spreadsheets/"+SHEETS_CONFIG.SPREADSHEET_ID+"/values/"+encodeURIComponent(SHEETS_CONFIG.SHEET_NAMES.HOMEPAGE+"!A:E")+":clear";t.then(function(){return fetch(a,{method:"POST",headers:{Authorization:"Bearer "+e}})}).then(function(e){return e.ok?e.json():e.json().then(function(e){throw new Error(e.error?e.error.message:"Failed to clear sheet")})}).then(function(){return O(SHEETS_CONFIG.SHEET_NAMES.HOMEPAGE+"!A1",n)}).then(function(){y("Homepage settings saved to Google Sheets!","success")}).catch(function(e){console.error("[Homepage] Error saving:",e),y("Error saving homepage settings: "+e.message,"error")})}()})})}();